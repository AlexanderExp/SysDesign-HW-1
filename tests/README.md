## Что покрывают автотесты

### 1. Слой данных (`shared`)

Файл: `tests/test_shared_repositories.py`

Проверяем репозитории, которые работают с БД (без HTTP и Docker):

* **IdempotencyRepository**

  * поиск записи по ключу (`None` / корректная запись);
  * сохранение и чтение кэшированного ответа как JSON.
  * **Сценарий:** повторный запрос с тем же `Idempotency-Key` получает тот же ответ без повторной бизнес-логики.

* **PaymentRepository**

  * создание успешных и неуспешных попыток платежей;
  * подсчёт суммы только успешных платежей;
  * выдача всех попыток / только успешных.
  * **Сценарий:** по аренде правильно считается, сколько реально оплачено.

* **QuoteRepository**

  * создание оффера с нужными полями;
  * получение существующего / несуществующего quote;
  * удаление (повторный delete безопасен).
  * **Сценарий:** система генерирует оффер, его можно прочитать и корректно удалить.

* **RentalRepository**

  * список активных аренд (`ACTIVE`);
  * обновление суммы `total_amount` (True/False при успехе/отсутствии аренды);
  * завершение аренды (`finish_rental`) и выставление `finished_at` только для `ACTIVE`;
  * перевод `ACTIVE` аренды в `BUYOUT`;
  * расчёт суммы к оплате с учётом:

    * бесплатного периода (`free_period_min`),
    * времени аренды,
    * отсутствующего `started_at`.
  * **Сценарий:** какие аренды "живые", сколько каждая должна сейчас и как меняются статус и время окончания.

* **DebtRepository**

  * получение текущего долга (0, если записи нет);
  * добавление/увеличение долга;
  * безопасное уменьшение долга (не даём уйти в минус, сбрасываем `attempts`);
  * инкремент попыток взыскивания + `last_attempt_at`;
  * решение, можно ли ретраить долг (`should_retry_debt` с учётом backoff);
  * обновление долга с явным `updated_at`.
  * **Сценарий:** ведём "копилку" долгов, учитываем попытки списания и решаем, когда снова пробовать.

---

### 2. HTTP / API сценарии

Файл: `tests/test_api_flows.py`

* **Health-check**

  * `/api/v1/health` -> 200 и непустой JSON.
  * **Сценарий:** сервис жив и отвечает.

* **Идемпотентный старт аренды**

  * `/rentals/quote` -> создаём оффер;
  * два вызова `/rentals/start` с одним `Idempotency-Key`;
  * оба раза 200, `order_id` одинаковый, в `rentals` одна запись с этим id.
  * **Сценарий:** повторный клик/повтор запроса не создаёт вторую аренду.

* **Старт с несуществующим quote**

  * `/rentals/start` с `quote_id="non-existing"` -> код 4xx.
  * **Сценарий:** нельзя начать аренду по битому идентификатору оффера.

* **Старт с протухшим оффером**

  * создаём `quote`;
  * в БД делаем `expires_at` в прошлом;
  * `/rentals/start` -> 4xx.
  * **Сценарий:** по истёкшему офферу старт аренды запрещён.

---

### 3. Бизнес-потоки биллинга

Файл: `tests/test_billing_flows.py`

Тесты работают через HTTP + БД, повторяют сценарии из старых bash-скриптов.

* **Периодический биллинг**

  * стартуем аренду;
  * несколько раз "отматываем" `started_at` назад и ждём `billing-worker`;
  * ожидаем >=1 успешную попытку списания и положительную сумму.
  * **Сценарий:** при длительной аренде биллинг регулярно начисляет оплату.

* **Buyout без долга (paid-only)**

  * стартуем аренду;
  * сильно отматываем `started_at` (сумма оплат превышает порог выкупа);
  * ждём биллинг;
  * проверяем:

    * есть успешные списания,
    * долг = 0,
    * статус `BUYOUT`/`FINISHED`;
  * дальше ждём ещё несколько тиков:

    * новых попыток нет,
    * сумма оплат не меняется,
    * долг по-прежнему 0.
  * **Сценарий:** при полном выкупе за счёт оплат аренда помечается как выкупленная, биллинг её больше не трогает.

* **Buyout с долгом (mixed paid + debt)**

  * стартуем аренду и даём биллингу "накрутить" первые оплаты;
  * вручную добавляем долг в `debts`;
  * ждём биллинг;
  * проверяем:

    * долг уменьшился или обнулился,
    * сумма успешных списаний не уменьшилась,
    * статус `BUYOUT`/`FINISHED`;
  * потом ждём ещё:

    * новых попыток нет,
    * сумма оплат и долг не меняются.
  * **Сценарий:** когда деньги появились, биллинг погашает долг и доводит аренду до buyout, после чего больше не трогает ни деньги, ни долг.

---

### Итог

Python-тесты сейчас проверяют:

1. **Корректность работы слоя данных (`shared`)**: аренды, платежи, офферы, долги, идемпотентность.
2. **Ключевые API-контракты**: живой health, идемпотентный старт аренды, корректные ошибки на невалидные / протухшие офферы.
3. **Основные сценарии биллинга во времени**: регулярные списания, buyout без долга и buyout с долгом с последующей остановкой биллинга по аренде.
