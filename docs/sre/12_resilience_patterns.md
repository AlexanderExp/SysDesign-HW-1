# 12. Паттерны отказоустойчивости

> **Сложность:** ⭐⭐⭐ Продвинутый уровень
> **Дополнительная тема** — расширение вопроса 9

---

## Обзор паттернов

```
┌─────────────────────────────────────────────────────────┐
│            ПАТТЕРНЫ ОТКАЗОУСТОЙЧИВОСТИ                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Защита от сбоев зависимостей:                          │
│  ├── Timeout          — не ждать вечно                  │
│  ├── Retry            — повторить при ошибке            │
│  ├── Circuit Breaker  — отключить сломанное             │
│  ├── Fallback         — запасной вариант                │
│  ├── Bulkhead         — изоляция ресурсов               │
│  └── Hedging          — параллельные запросы            │
│                                                         │
│  Защита от перегрузки:                                  │
│  ├── Rate Limiting    — ограничить частоту              │
│  ├── Load Shedding    — сбросить лишнее                 │
│  ├── Backpressure     — сигнал замедлиться              │
│  └── Throttling       — замедлить обработку             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Timeout (Таймаут)

### Зачем нужен?

```
┌─────────────────────────────────────────────────────────┐
│                      TIMEOUT                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Зависимость зависла, мы ждём бесконечно      │
│                                                         │
│  ❌ Без таймаута:                                       │
│                                                         │
│  Client ──► Service ──► Database (завис!)               │
│     │                       │                           │
│     │       ждём...         │                           │
│     │       ждём...         │                           │
│     │       ждём...         │ (никогда не ответит)      │
│     │                       │                           │
│  Thread заблокирован навсегда!                          │
│  Все потоки заблокированы → сервис мёртв               │
│                                                         │
│  ✅ С таймаутом:                                        │
│                                                         │
│  Client ──► Service ──► Database (завис!)               │
│     │          │            │                           │
│     │     5 сек │            │                           │
│     │◄── ERROR ─┘            │                           │
│                                                         │
│  Через 5 секунд — ошибка, поток освобождён              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Типы таймаутов

```
┌─────────────────────────────────────────────────────────┐
│                   ТИПЫ ТАЙМАУТОВ                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. CONNECTION TIMEOUT                                  │
│     Время на установку соединения                       │
│     Обычно: 1-5 секунд                                  │
│                                                         │
│  2. READ TIMEOUT (Socket Timeout)                       │
│     Время ожидания данных после установки соединения    │
│     Обычно: 5-30 секунд                                 │
│                                                         │
│  3. REQUEST TIMEOUT (Total Timeout)                     │
│     Общее время на весь запрос                          │
│     = connection + все reads + обработка                │
│                                                         │
│  Пример (Python requests):                              │
│                                                         │
│  requests.get(url, timeout=(3, 10))                     │
│                    │     │                              │
│                    │     └── read timeout: 10 сек       │
│                    └──────── connect timeout: 3 сек     │
│                                                         │
│  ⚠️ Правила:                                            │
│  • ВСЕГДА устанавливай таймауты                         │
│  • Таймаут < SLO по latency                             │
│  • Учитывай retries: total_time = timeout × retries     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Retry (Повторная попытка)

### Зачем нужен?

```
┌─────────────────────────────────────────────────────────┐
│                       RETRY                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Временные сбои (сеть моргнула, сервис        │
│            перезапускался)                              │
│                                                         │
│  Решение: Повторить запрос                              │
│                                                         │
│  Client ──► Service                                     │
│     │          │                                        │
│     │◄── FAIL ─┘  (1-я попытка)                         │
│     │                                                   │
│     │──► Service                                        │
│     │◄── FAIL ─┘  (2-я попытка)                         │
│     │                                                   │
│     │──► Service                                        │
│     │◄── OK ────┘  (3-я попытка — успех!)               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Exponential Backoff

```
┌─────────────────────────────────────────────────────────┐
│               EXPONENTIAL BACKOFF                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Если все клиенты ретраят одновременно        │
│            → ещё больше нагрузки на упавший сервис      │
│                                                         │
│  ❌ Retry без backoff:                                  │
│                                                         │
│  Попытка 1: fail → retry немедленно                     │
│  Попытка 2: fail → retry немедленно                     │
│  Попытка 3: fail → retry немедленно                     │
│  ...                                                    │
│  = DDoS на собственный сервис!                          │
│                                                         │
│  ✅ Exponential Backoff:                                │
│                                                         │
│  Попытка 1: fail → ждём 1 сек                           │
│  Попытка 2: fail → ждём 2 сек                           │
│  Попытка 3: fail → ждём 4 сек                           │
│  Попытка 4: fail → ждём 8 сек                           │
│  ...                                                    │
│                                                         │
│  Формула: delay = base × 2^attempt                      │
│                                                         │
│  + JITTER (случайный разброс):                          │
│  delay = base × 2^attempt × random(0.5, 1.5)            │
│                                                         │
│  Jitter нужен, чтобы клиенты не ретраили синхронно      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Когда НЕ ретраить

```
┌─────────────────────────────────────────────────────────┐
│                КОГДА НЕ РЕТРАИТЬ                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✅ РЕТРАЙ (transient errors):                          │
│  • 500 Internal Server Error                            │
│  • 502 Bad Gateway                                      │
│  • 503 Service Unavailable                              │
│  • 504 Gateway Timeout                                  │
│  • Connection refused                                   │
│  • Timeout                                              │
│                                                         │
│  ❌ НЕ РЕТРАЙ (permanent errors):                       │
│  • 400 Bad Request (наш запрос кривой)                  │
│  • 401 Unauthorized (нет авторизации)                   │
│  • 403 Forbidden (нет прав)                             │
│  • 404 Not Found (ресурса нет)                          │
│  • 422 Unprocessable Entity                             │
│                                                         │
│  ⚠️ ОСТОРОЖНО:                                          │
│  • 429 Too Many Requests — ретрай с большим backoff     │
│  • POST запросы — только если идемпотентные!            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Идемпотентность

```
┌─────────────────────────────────────────────────────────┐
│                  ИДЕМПОТЕНТНОСТЬ                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идемпотентная операция: повторное выполнение           │
│  даёт тот же результат                                  │
│                                                         │
│  ✅ Идемпотентные:                                      │
│  • GET /users/123           (чтение)                    │
│  • PUT /users/123 {name:X}  (полная замена)             │
│  • DELETE /users/123        (удаление)                  │
│                                                         │
│  ❌ НЕ идемпотентные:                                   │
│  • POST /orders             (создание)                  │
│  • POST /payments           (платёж)                    │
│  • PATCH /balance +100      (инкремент)                 │
│                                                         │
│  Как сделать идемпотентным:                             │
│                                                         │
│  Idempotency Key:                                       │
│  POST /payments                                         │
│  Idempotency-Key: abc-123-xyz                           │
│  {amount: 100}                                          │
│                                                         │
│  Сервер запоминает: "abc-123-xyz уже обработан"         │
│  При повторном запросе — возвращает тот же результат    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Circuit Breaker (Предохранитель)

### Зачем нужен?

```
┌─────────────────────────────────────────────────────────┐
│                  CIRCUIT BREAKER                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Зависимость упала, но мы продолжаем          │
│            отправлять запросы → тратим ресурсы          │
│                                                         │
│  Аналогия: Электрический предохранитель                 │
│            При перегрузке — отключает цепь              │
│                                                         │
│  Состояния:                                             │
│                                                         │
│  ┌─────────┐    ошибки > порог    ┌─────────┐           │
│  │ CLOSED  │ ─────────────────────►│  OPEN   │           │
│  │(работаем)│                      │(откл.)  │           │
│  └─────────┘                       └────┬────┘           │
│       ▲                                 │               │
│       │                            timeout              │
│       │                                 │               │
│       │         ┌───────────┐           │               │
│       │         │ HALF-OPEN │◄──────────┘               │
│       │         │ (пробуем) │                           │
│       │         └─────┬─────┘                           │
│       │               │                                 │
│       │    успех      │    ошибка                       │
│       └───────────────┘─────────────► OPEN              │
│                                                         │
│  CLOSED: Запросы проходят нормально                     │
│  OPEN: Запросы сразу отклоняются (fail fast)            │
│  HALF-OPEN: Пробуем один запрос                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Параметры Circuit Breaker

```
┌─────────────────────────────────────────────────────────┐
│              ПАРАМЕТРЫ CIRCUIT BREAKER                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. FAILURE THRESHOLD                                   │
│     Сколько ошибок для открытия                         │
│     Пример: 5 ошибок подряд или 50% за минуту           │
│                                                         │
│  2. SUCCESS THRESHOLD                                   │
│     Сколько успехов в HALF-OPEN для закрытия            │
│     Пример: 3 успешных запроса подряд                   │
│                                                         │
│  3. TIMEOUT                                             │
│     Сколько ждать в OPEN перед HALF-OPEN                │
│     Пример: 30 секунд                                   │
│                                                         │
│  4. SLIDING WINDOW                                      │
│     Окно для подсчёта ошибок                            │
│     Пример: последние 10 запросов или 1 минута          │
│                                                         │
│  Пример конфига:                                        │
│                                                         │
│  circuit_breaker:                                       │
│    failure_rate_threshold: 50      # 50% ошибок         │
│    slow_call_rate_threshold: 80    # 80% медленных      │
│    slow_call_duration: 2s          # > 2s = медленный   │
│    sliding_window_size: 100        # последние 100      │
│    wait_duration_in_open: 30s      # ждать 30 сек       │
│    permitted_in_half_open: 3       # 3 пробных запроса  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Fallback (Запасной вариант)

```
┌─────────────────────────────────────────────────────────┐
│                      FALLBACK                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Если основной путь не работает — используй       │
│        запасной                                         │
│                                                         │
│  Примеры:                                               │
│                                                         │
│  1. КЭШИРОВАННЫЕ ДАННЫЕ                                 │
│     Recommendation Service упал                         │
│     → Показываем популярные товары из кэша              │
│                                                         │
│  2. ДЕФОЛТНОЕ ЗНАЧЕНИЕ                                  │
│     Pricing Service упал                                │
│     → Показываем базовую цену                           │
│                                                         │
│  3. УПРОЩЁННАЯ ЛОГИКА                                   │
│     ML-сервис упал                                      │
│     → Используем простые правила                        │
│                                                         │
│  4. ДРУГОЙ СЕРВИС                                       │
│     Primary DB недоступна                               │
│     → Читаем из реплики                                 │
│                                                         │
│  Код:                                                   │
│                                                         │
│  def get_recommendations(user_id):                      │
│      try:                                               │
│          return recommendation_service.get(user_id)     │
│      except ServiceUnavailable:                         │
│          # Fallback: популярные товары                  │
│          return cache.get("popular_products")           │
│                                                         │
│  ⚠️ Важно: Fallback должен быть надёжнее основного!     │
│     Не делай fallback на другой ненадёжный сервис       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Bulkhead (Переборка)

```
┌─────────────────────────────────────────────────────────┐
│                      BULKHEAD                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Аналогия: Переборки в корабле                          │
│            Если один отсек затоплен — другие защищены   │
│                                                         │
│  Идея: Изолировать ресурсы для разных операций          │
│                                                         │
│  ❌ Без Bulkhead:                                       │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │           Общий Thread Pool (100)               │    │
│  │  ┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐...   │    │
│  │  │ A ││ A ││ A ││ A ││ A ││ A ││ A ││ A │       │    │
│  │  └───┘└───┘└───┘└───┘└───┘└───┘└───┘└───┘       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Сервис A завис → все 100 потоков заняты                │
│  → Сервисы B и C не могут работать!                     │
│                                                         │
│  ✅ С Bulkhead:                                         │
│                                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │  Pool A (30)│ │  Pool B (30)│ │  Pool C (40)│        │
│  │ ┌───┐┌───┐  │ │ ┌───┐┌───┐  │ │ ┌───┐┌───┐  │        │
│  │ │ A ││ A │  │ │ │ B ││ B │  │ │ │ C ││ C │  │        │
│  │ └───┘└───┘  │ │ └───┘└───┘  │ │ └───┘└───┘  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
│                                                         │
│  Сервис A завис → только Pool A занят                   │
│  → Сервисы B и C продолжают работать!                   │
│                                                         │
│  Типы Bulkhead:                                         │
│  • Thread Pool Bulkhead — отдельные пулы потоков        │
│  • Semaphore Bulkhead — ограничение concurrent calls    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Hedging (Хеджирование)

```
┌─────────────────────────────────────────────────────────┐
│                      HEDGING                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Отправить несколько запросов параллельно,        │
│        использовать первый успешный ответ               │
│                                                         │
│  ┌────────┐                                             │
│  │ Client │                                             │
│  └───┬────┘                                             │
│      │                                                  │
│      ├────────────────► Server 1 ────► (медленно...)    │
│      │                                                  │
│      ├────────────────► Server 2 ────► Response! ✓      │
│      │                                                  │
│      └────────────────► Server 3 ────► (cancel)         │
│                                                         │
│  Используем ответ от Server 2, остальные отменяем       │
│                                                         │
│  Когда использовать:                                    │
│  • Критичные запросы с жёстким SLO                      │
│  • Есть несколько реплик/инстансов                      │
│  • Запросы идемпотентные                                │
│                                                         │
│  ⚠️ Недостатки:                                         │
│  • Увеличивает нагрузку (2-3x запросов)                 │
│  • Тратит ресурсы                                       │
│                                                         │
│  Вариант: Hedged Request                                │
│  1. Отправляем первый запрос                            │
│  2. Если нет ответа за p95 latency — отправляем второй  │
│  3. Используем первый пришедший ответ                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Комбинирование паттернов

```
┌─────────────────────────────────────────────────────────┐
│              КОМБИНИРОВАНИЕ ПАТТЕРНОВ                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Типичный порядок:                                      │
│                                                         │
│  Request                                                │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────┐                                    │
│  │  Rate Limiter   │ ← Защита от перегрузки             │
│  └────────┬────────┘                                    │
│           │                                             │
│           ▼                                             │
│  ┌─────────────────┐                                    │
│  │ Circuit Breaker │ ← Fail fast если сервис упал       │
│  └────────┬────────┘                                    │
│           │                                             │
│           ▼                                             │
│  ┌─────────────────┐                                    │
│  │    Bulkhead     │ ← Изоляция ресурсов                │
│  └────────┬────────┘                                    │
│           │                                             │
│           ▼                                             │
│  ┌─────────────────┐                                    │
│  │  Retry + Backoff│ ← Повтор при временных ошибках     │
│  └────────┬────────┘                                    │
│           │                                             │
│           ▼                                             │
│  ┌─────────────────┐                                    │
│  │    Timeout      │ ← Не ждать вечно                   │
│  └────────┬────────┘                                    │
│           │                                             │
│           ▼                                             │
│  ┌─────────────────┐                                    │
│  │    Fallback     │ ← Запасной вариант при ошибке      │
│  └─────────────────┘                                    │
│                                                         │
│  Библиотеки:                                            │
│  • Python: tenacity, circuitbreaker                     │
│  • Java: Resilience4j, Hystrix (deprecated)             │
│  • Go: go-resiliency                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **Timeout** | Максимальное время ожидания ответа |
| **Retry** | Повторная попытка при ошибке |
| **Exponential Backoff** | Экспоненциально растущая задержка между ретраями |
| **Jitter** | Случайный разброс в задержке |
| **Идемпотентность** | Повторное выполнение даёт тот же результат |
| **Circuit Breaker** | Отключение вызовов к упавшему сервису |
| **Fallback** | Запасной вариант при ошибке |
| **Bulkhead** | Изоляция ресурсов между операциями |
| **Hedging** | Параллельные запросы к нескольким серверам |

---

## Что запомнить

1. **Timeout ВСЕГДА** — никогда не жди вечно
2. **Retry с Exponential Backoff + Jitter** — не DDoS-ь себя
3. **Ретрай только transient ошибки** — 5xx да, 4xx нет
4. **Circuit Breaker = fail fast** — не трать ресурсы на мёртвое
5. **Fallback должен быть надёжнее** основного пути
6. **Bulkhead изолирует сбои** — один упавший не убьёт всех

---

*Следующий файл: [13. Кэширование](13_caching.md)*

