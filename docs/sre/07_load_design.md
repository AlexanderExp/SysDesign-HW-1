# 07. Проектирование под нагрузку

> **Сложность:** ⭐⭐ Средний уровень
> **Вопросы из списка:** 9

---

## Вопрос 9: Что учитывать при проектировании/тестировании реакции на аномальную нагрузку?

### Что такое аномальная нагрузка?

**Аномальная нагрузка** — это нагрузка, превышающая нормальные показатели:

```
┌─────────────────────────────────────────────────────────┐
│                  ВИДЫ НАГРУЗКИ                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Нормальная нагрузка:                                   │
│  ────────────────────                                   │
│  │     ▁▂▃▂▁▂▃▂▁▂▃▂▁▂▃▂▁                               │
│  └─────────────────────────────────────────► время      │
│                                                         │
│  Пиковая нагрузка (spike):                              │
│  ────────────────────────                               │
│  │              ▄█▄                                     │
│  │     ▁▂▃▂▁▂▃▂█████▂▃▂▁▂▃▂▁                           │
│  └─────────────────────────────────────────► время      │
│                                                         │
│  Постепенный рост (ramp-up):                            │
│  ──────────────────────────                             │
│  │                    ▄▄▄▄▄▄▄▄                          │
│  │           ▂▂▂▂▄▄▄▄█████████                          │
│  │     ▁▁▁▂▂▄████████████████                           │
│  └─────────────────────────────────────────► время      │
│                                                         │
│  DDoS атака:                                            │
│  ───────────                                            │
│  │     █████████████████████████                        │
│  │     █████████████████████████                        │
│  │     █████████████████████████                        │
│  └─────────────────────────────────────────► время      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Примеры источников аномальной нагрузки

```
┌─────────────────────────────────────────────────────────┐
│              ИСТОЧНИКИ АНОМАЛЬНОЙ НАГРУЗКИ              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📱 МАРКЕТИНГ                                           │
│  • Реклама на ТВ                                        │
│  • Вирусный пост в соцсетях                             │
│  • Распродажа (Black Friday)                            │
│                                                         │
│  📰 СОБЫТИЯ                                             │
│  • Новость о компании                                   │
│  • Релиз продукта                                       │
│  • Спортивное событие (финал ЧМ)                        │
│                                                         │
│  🔄 ТЕХНИЧЕСКИЕ                                         │
│  • Retry storm (клиенты ретраят после сбоя)             │
│  • Thundering herd (все клиенты одновременно)           │
│  • Кэш expiration (массовая инвалидация)                │
│                                                         │
│  ⚔️ АТАКИ                                               │
│  • DDoS                                                 │
│  • Brute force                                          │
│  • Scraping                                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Что учитывать при проектировании

### 1. Определи пределы системы

```
┌─────────────────────────────────────────────────────────┐
│                   CAPACITY PLANNING                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Вопросы:                                               │
│  • Какая нормальная нагрузка?                           │
│  • Какой максимум система выдержит?                     │
│  • Какой запас прочности нужен?                         │
│                                                         │
│  Пример:                                                │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Метрика          │ Норма  │ Пик    │ Лимит     │    │
│  ├───────────────────┼────────┼────────┼───────────┤    │
│  │ RPS              │ 1,000  │ 5,000  │ 10,000    │    │
│  │ Concurrent users │ 10,000 │ 50,000 │ 100,000   │    │
│  │ Response time    │ 100ms  │ 500ms  │ 2,000ms   │    │
│  │ CPU usage        │ 30%    │ 70%    │ 90%       │    │
│  │ Memory usage     │ 50%    │ 80%    │ 95%       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Правило: Планируй на 2-3x от ожидаемого пика           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2. Механизмы защиты от перегрузки

#### Rate Limiting (ограничение скорости)

```
┌─────────────────────────────────────────────────────────┐
│                    RATE LIMITING                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Ограничить количество запросов от клиента        │
│                                                         │
│  Клиент A: 100 req/min ✓                                │
│  Клиент B: 100 req/min ✓                                │
│  Клиент C: 5000 req/min → 429 Too Many Requests ✗       │
│                                                         │
│  Алгоритмы:                                             │
│                                                         │
│  1. Token Bucket:                                       │
│     ┌─────────┐                                         │
│     │ Bucket  │ ← Токены добавляются с фикс. скоростью  │
│     │ ●●●●●   │                                         │
│     └────┬────┘                                         │
│          │                                              │
│     Запрос берёт токен. Нет токена = отказ.             │
│                                                         │
│  2. Sliding Window:                                     │
│     Считаем запросы за последние N секунд               │
│                                                         │
│  3. Fixed Window:                                       │
│     Считаем запросы в текущую минуту/час                │
│                                                         │
│  Уровни Rate Limiting:                                  │
│  • По IP адресу                                         │
│  • По пользователю (API key)                            │
│  • По endpoint                                          │
│  • Глобально                                            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Circuit Breaker (предохранитель)

```
┌─────────────────────────────────────────────────────────┐
│                   CIRCUIT BREAKER                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Если зависимость падает — прекратить вызовы      │
│                                                         │
│  Состояния:                                             │
│                                                         │
│  ┌─────────┐    ошибки > порог    ┌─────────┐           │
│  │ CLOSED  │ ─────────────────────►│  OPEN   │           │
│  │(работаем)│                      │(отказ)  │           │
│  └─────────┘                       └────┬────┘           │
│       ▲                                 │               │
│       │                            timeout              │
│       │                                 │               │
│       │         ┌─────────┐             │               │
│       │         │HALF-OPEN│◄────────────┘               │
│       │         │(пробуем)│                             │
│       │         └────┬────┘                             │
│       │              │                                  │
│       │    успех     │    ошибка                        │
│       └──────────────┘──────────► OPEN                  │
│                                                         │
│  Пример:                                                │
│  • 5 ошибок подряд → OPEN (отклоняем запросы)           │
│  • Через 30 сек → HALF-OPEN (пробуем 1 запрос)          │
│  • Успех → CLOSED (работаем нормально)                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Bulkhead (переборка)

```
┌─────────────────────────────────────────────────────────┐
│                      BULKHEAD                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Изолировать ресурсы, чтобы сбой одного           │
│        не повлиял на другие                             │
│                                                         │
│  Без Bulkhead:                                          │
│  ┌─────────────────────────────────────────┐            │
│  │           Общий Thread Pool             │            │
│  │  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐   │            │
│  │  │ A │ │ A │ │ A │ │ A │ │ A │ │ A │   │            │
│  │  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘   │            │
│  └─────────────────────────────────────────┘            │
│  Сервис A завис → все потоки заняты → B и C не работают │
│                                                         │
│  С Bulkhead:                                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │  Pool A     │ │  Pool B     │ │  Pool C     │        │
│  │ ┌───┐┌───┐  │ │ ┌───┐┌───┐  │ │ ┌───┐┌───┐  │        │
│  │ │ A ││ A │  │ │ │ B ││ B │  │ │ │ C ││ C │  │        │
│  │ └───┘└───┘  │ │ └───┘└───┘  │ │ └───┘└───┘  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
│  Сервис A завис → только Pool A занят → B и C работают! │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Backpressure (противодавление)

```
┌─────────────────────────────────────────────────────────┐
│                    BACKPRESSURE                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Если не успеваем обрабатывать — сигнализируем    │
│        источнику замедлиться                            │
│                                                         │
│  Без Backpressure:                                      │
│  Producer ═══════════════════► Queue ═══► Consumer      │
│  (1000/s)                      (переполнение!)  (100/s) │
│                                                         │
│  С Backpressure:                                        │
│  Producer ◄─── "Замедлись!" ─── Queue ═══► Consumer     │
│  (100/s)                        (OK)        (100/s)     │
│                                                         │
│  Реализации:                                            │
│  • Ограничение размера очереди                          │
│  • TCP flow control                                     │
│  • HTTP 429 / 503                                       │
│  • Reactive Streams                                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3. Graceful Degradation (изящная деградация)

```
┌─────────────────────────────────────────────────────────┐
│                GRACEFUL DEGRADATION                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: При перегрузке отключай некритичные функции      │
│                                                         │
│  Нормальный режим:                                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │ ✓ Каталог товаров                               │    │
│  │ ✓ Рекомендации (ML)                             │    │
│  │ ✓ Отзывы                                        │    │
│  │ ✓ Персонализация                                │    │
│  │ ✓ Аналитика в реальном времени                  │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Режим высокой нагрузки:                                │
│  ┌─────────────────────────────────────────────────┐    │
│  │ ✓ Каталог товаров                               │    │
│  │ ✗ Рекомендации → показываем популярное          │    │
│  │ ✗ Отзывы → кэшированные                         │    │
│  │ ✗ Персонализация → отключена                    │    │
│  │ ✗ Аналитика → отложена                          │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Приоритеты функций:                                    │
│  1. Критичные (покупка, оплата) — всегда работают       │
│  2. Важные (каталог, поиск) — работают с упрощениями    │
│  3. Некритичные (рекомендации) — отключаются первыми    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4. Load Shedding (сброс нагрузки)

```
┌─────────────────────────────────────────────────────────┐
│                    LOAD SHEDDING                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Лучше отклонить часть запросов, чем упасть       │
│        полностью                                        │
│                                                         │
│  Без Load Shedding:                                     │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Нагрузка: ████████████████████████ (200%)       │    │
│  │ Результат: Всё падает, 0% успешных              │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  С Load Shedding:                                       │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Нагрузка: ████████████████████████ (200%)       │    │
│  │ Принято:  ████████████ (100%)                   │    │
│  │ Отклонено: ████████████ (100%) → 503            │    │
│  │ Результат: 50% успешных (лучше чем 0%!)         │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Стратегии отклонения:                                  │
│  • FIFO — отклоняем новые запросы                       │
│  • LIFO — отклоняем старые (они уже timeout)            │
│  • Random — случайно                                    │
│  • Priority — по приоритету (VIP клиенты важнее)        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5. Auto-scaling (автомасштабирование)

```
┌─────────────────────────────────────────────────────────┐
│                    AUTO-SCALING                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Идея: Автоматически добавлять/убирать инстансы         │
│                                                         │
│  Нагрузка растёт:                                       │
│  ┌───┐ ┌───┐        ┌───┐ ┌───┐ ┌───┐ ┌───┐            │
│  │ 1 │ │ 2 │   →    │ 1 │ │ 2 │ │ 3 │ │ 4 │            │
│  └───┘ └───┘        └───┘ └───┘ └───┘ └───┘            │
│                                                         │
│  Нагрузка падает:                                       │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐        ┌───┐ ┌───┐            │
│  │ 1 │ │ 2 │ │ 3 │ │ 4 │   →    │ 1 │ │ 2 │            │
│  └───┘ └───┘ └───┘ └───┘        └───┘ └───┘            │
│                                                         │
│  Метрики для масштабирования:                           │
│  • CPU usage > 70% → scale up                           │
│  • Request queue > 100 → scale up                       │
│  • Response time > 500ms → scale up                     │
│                                                         │
│  ⚠️ Проблемы:                                           │
│  • Время на запуск инстанса (1-5 мин)                   │
│  • Не успеет при резком spike                           │
│  • Нужен запас (over-provisioning)                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Тестирование под нагрузкой

### Виды нагрузочного тестирования

```
┌─────────────────────────────────────────────────────────┐
│              ВИДЫ НАГРУЗОЧНОГО ТЕСТИРОВАНИЯ             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. LOAD TEST (нагрузочное)                             │
│     Проверка при ожидаемой нагрузке                     │
│     "Выдержит ли система 1000 RPS?"                     │
│                                                         │
│  2. STRESS TEST (стресс-тест)                           │
│     Проверка при нагрузке выше нормы                    │
│     "Что будет при 5000 RPS?"                           │
│                                                         │
│  3. SPIKE TEST (пиковое)                                │
│     Резкий скачок нагрузки                              │
│     "Что будет при внезапном 10x?"                      │
│                                                         │
│  4. SOAK TEST (длительное)                              │
│     Долгая работа под нагрузкой                         │
│     "Нет ли утечек памяти за 24 часа?"                  │
│                                                         │
│  5. BREAKPOINT TEST                                     │
│     Найти точку отказа                                  │
│     "При какой нагрузке система падает?"                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Что измерять при тестировании

```
┌─────────────────────────────────────────────────────────┐
│                 ЧТО ИЗМЕРЯТЬ                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  LATENCY (задержка):                                    │
│  • p50 — медиана (50% запросов быстрее)                 │
│  • p95 — 95-й перцентиль                                │
│  • p99 — 99-й перцентиль (worst case)                   │
│  • max — максимум                                       │
│                                                         │
│  THROUGHPUT (пропускная способность):                   │
│  • Requests per second (RPS)                            │
│  • Transactions per second (TPS)                        │
│                                                         │
│  ERROR RATE (частота ошибок):                           │
│  • 5xx ошибки                                           │
│  • Таймауты                                             │
│  • Отклонённые запросы                                  │
│                                                         │
│  RESOURCE USAGE (ресурсы):                              │
│  • CPU                                                  │
│  • Memory                                               │
│  • Disk I/O                                             │
│  • Network                                              │
│  • DB connections                                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Инструменты нагрузочного тестирования

```
┌─────────────────────────────────────────────────────────┐
│                   ИНСТРУМЕНТЫ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Генераторы нагрузки:                                   │
│  • k6 — современный, JavaScript сценарии                │
│  • Locust — Python, распределённый                      │
│  • JMeter — Java, GUI, много протоколов                 │
│  • wrk — простой, высокая производительность            │
│  • Gatling — Scala, красивые отчёты                     │
│  • Artillery — Node.js, YAML сценарии                   │
│                                                         │
│  Пример k6:                                             │
│  ```javascript                                          │
│  import http from 'k6/http';                            │
│                                                         │
│  export const options = {                               │
│    stages: [                                            │
│      { duration: '1m', target: 100 },  // ramp up       │
│      { duration: '5m', target: 100 },  // stay          │
│      { duration: '1m', target: 0 },    // ramp down     │
│    ],                                                   │
│  };                                                     │
│                                                         │
│  export default function () {                           │
│    http.get('https://api.example.com/users');           │
│  }                                                      │
│  ```                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Чек-лист тестирования

```
┌─────────────────────────────────────────────────────────┐
│                ЧЕК-ЛИСТ ТЕСТИРОВАНИЯ                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  □ Определены SLO (latency p99 < 500ms)                 │
│  □ Известна нормальная нагрузка                         │
│  □ Известен ожидаемый пик                               │
│                                                         │
│  □ Проведён load test (нормальная нагрузка)             │
│  □ Проведён stress test (2-3x от нормы)                 │
│  □ Проведён spike test (внезапный 10x)                  │
│  □ Проведён soak test (24+ часов)                       │
│  □ Найдена точка отказа (breakpoint)                    │
│                                                         │
│  □ Проверен rate limiting                               │
│  □ Проверен circuit breaker                             │
│  □ Проверена graceful degradation                       │
│  □ Проверен auto-scaling                                │
│                                                         │
│  □ Задокументированы результаты                         │
│  □ Настроены алерты на аномалии                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Вопрос 7 (дополнительно): Откат приложения и миграции данных

### Можно ли всегда откатить приложение?

```
┌─────────────────────────────────────────────────────────┐
│                ОТКАТ ПРИЛОЖЕНИЯ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Простой случай: Код без изменений БД                   │
│  ─────────────────────────────────────                  │
│  v1.0 → v1.1 → v1.0 (откат)                             │
│  ✅ Легко! Просто деплоим старую версию                 │
│                                                         │
│  Сложный случай: Код + миграция БД                      │
│  ─────────────────────────────────────                  │
│  v1.0 (schema v1) → v1.1 (schema v2) → ???              │
│  ❌ Сложно! Нужна обратная миграция                     │
│                                                         │
│  Невозможный случай: Деструктивные изменения            │
│  ─────────────────────────────────────────              │
│  • DROP COLUMN — данные потеряны                        │
│  • Изменение формата данных                             │
│  • Удаление таблиц                                      │
│  ❌ Невозможно откатить без бэкапа!                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Зачем нужен откат?

```
┌─────────────────────────────────────────────────────────┐
│                 ЗАЧЕМ ОТКАТ                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Баг в новой версии                                  │
│     Выкатили v2.0 → пользователи жалуются → откат       │
│                                                         │
│  2. Проблемы с производительностью                      │
│     Новая версия медленнее → откат                      │
│                                                         │
│  3. Несовместимость                                     │
│     Новый API ломает клиентов → откат                   │
│                                                         │
│  4. Частичный откат (canary)                            │
│     1% пользователей на v2.0 → проблемы → откат 1%      │
│                                                         │
│  Правило: Всегда планируй откат ДО деплоя!              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Проблемы с миграциями данных

```
┌─────────────────────────────────────────────────────────┐
│              ПРОБЛЕМЫ МИГРАЦИЙ                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. БЛОКИРОВКИ                                          │
│     ALTER TABLE на большой таблице → блокировка         │
│     Решение: Online DDL, pt-online-schema-change        │
│                                                         │
│  2. ДОЛГИЕ МИГРАЦИИ                                     │
│     Миграция 100M строк → часы                          │
│     Решение: Batch updates, фоновые миграции            │
│                                                         │
│  3. НЕСОВМЕСТИМОСТЬ ВЕРСИЙ                              │
│     v1 код читает старую схему                          │
│     v2 код читает новую схему                           │
│     Во время деплоя работают ОБЕ версии!                │
│                                                         │
│     Решение: Expand-Contract pattern                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Expand-Contract Pattern

```
┌─────────────────────────────────────────────────────────┐
│                EXPAND-CONTRACT                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Задача: Переименовать колонку name → full_name         │
│                                                         │
│  ❌ ПЛОХО: Одна миграция                                │
│  ALTER TABLE users RENAME COLUMN name TO full_name;     │
│  → Старый код сломается!                                │
│                                                         │
│  ✅ ХОРОШО: Три этапа                                   │
│                                                         │
│  1. EXPAND: Добавить новую колонку                      │
│     ALTER TABLE users ADD COLUMN full_name VARCHAR;     │
│     Код v1: читает name                                 │
│     Код v2: читает name, пишет в оба                    │
│                                                         │
│  2. MIGRATE: Скопировать данные                         │
│     UPDATE users SET full_name = name WHERE ...;        │
│     (batch по 1000 строк)                               │
│                                                         │
│  3. CONTRACT: Удалить старую колонку                    │
│     Код v3: читает только full_name                     │
│     ALTER TABLE users DROP COLUMN name;                 │
│                                                         │
│  Каждый этап — отдельный деплой!                        │
│  Можно откатить на любом этапе!                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **Rate Limiting** | Ограничение количества запросов |
| **Circuit Breaker** | Отключение вызовов к упавшему сервису |
| **Bulkhead** | Изоляция ресурсов между компонентами |
| **Backpressure** | Сигнал замедлиться при перегрузке |
| **Graceful Degradation** | Отключение некритичных функций |
| **Load Shedding** | Отклонение части запросов при перегрузке |
| **Auto-scaling** | Автоматическое изменение числа инстансов |
| **Expand-Contract** | Паттерн безопасных миграций БД |

---

## Что запомнить

1. **Определи пределы системы** до того, как столкнёшься с нагрузкой
2. **Rate limiting + Circuit Breaker** — базовая защита
3. **Лучше отклонить часть запросов**, чем упасть полностью
4. **Graceful degradation** — отключай некритичное первым
5. **Тестируй spike и stress** — не только нормальную нагрузку
6. **Планируй откат** до деплоя, используй Expand-Contract

---

*Следующий файл: [08. Мониторинг и метрики](08_monitoring_metrics.md)*

