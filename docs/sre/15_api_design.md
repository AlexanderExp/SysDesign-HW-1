# 15. Проектирование API

> **Сложность:** ⭐⭐ Средний уровень
> **Дополнительная тема** — критически важна для System Design

---

## Что такое API?

```
┌─────────────────────────────────────────────────────────┐
│                      ЧТО ТАКОЕ API                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  API (Application Programming Interface) —              │
│  контракт между системами                               │
│                                                         │
│  ┌──────────┐     API Contract     ┌──────────┐         │
│  │  Client  │◄───────────────────►│  Server  │         │
│  └──────────┘                      └──────────┘         │
│                                                         │
│  Контракт определяет:                                   │
│  • Какие операции доступны                              │
│  • Формат запросов                                      │
│  • Формат ответов                                       │
│  • Коды ошибок                                          │
│  • Аутентификацию                                       │
│                                                         │
│  Типы API:                                              │
│  • REST — HTTP + JSON                                   │
│  • gRPC — HTTP/2 + Protocol Buffers                     │
│  • GraphQL — Query language                             │
│  • WebSocket — Real-time bidirectional                  │
│  • SOAP — XML (legacy)                                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## REST API

### Принципы REST

```
┌─────────────────────────────────────────────────────────┐
│                    ПРИНЦИПЫ REST                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  REST = REpresentational State Transfer                 │
│                                                         │
│  1. CLIENT-SERVER                                       │
│     Клиент и сервер разделены                           │
│                                                         │
│  2. STATELESS                                           │
│     Сервер не хранит состояние клиента                  │
│     Каждый запрос содержит всю информацию               │
│                                                         │
│  3. CACHEABLE                                           │
│     Ответы можно кэшировать                             │
│                                                         │
│  4. UNIFORM INTERFACE                                   │
│     Единообразный интерфейс                             │
│     • Ресурсы идентифицируются URI                      │
│     • Манипуляция через представления                   │
│     • Self-descriptive messages                         │
│     • HATEOAS (гиперссылки)                             │
│                                                         │
│  5. LAYERED SYSTEM                                      │
│     Клиент не знает, с чем общается                     │
│     (прокси, балансировщик, сервер)                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### HTTP методы

```
┌─────────────────────────────────────────────────────────┐
│                    HTTP МЕТОДЫ                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────┬───────────────┬──────────┬──────────────┐  │
│  │ Метод   │ Действие      │ Идемпот. │ Safe         │  │
│  ├─────────┼───────────────┼──────────┼──────────────┤  │
│  │ GET     │ Получить      │ Да       │ Да           │  │
│  │ POST    │ Создать       │ Нет      │ Нет          │  │
│  │ PUT     │ Заменить      │ Да       │ Нет          │  │
│  │ PATCH   │ Обновить часть│ Нет      │ Нет          │  │
│  │ DELETE  │ Удалить       │ Да       │ Нет          │  │
│  └─────────┴───────────────┴──────────┴──────────────┘  │
│                                                         │
│  Идемпотентность: повторный вызов = тот же результат    │
│  Safe: не изменяет состояние                            │
│                                                         │
│  Примеры:                                               │
│                                                         │
│  GET    /users          — список пользователей          │
│  GET    /users/123      — один пользователь             │
│  POST   /users          — создать пользователя          │
│  PUT    /users/123      — заменить пользователя         │
│  PATCH  /users/123      — обновить поля                 │
│  DELETE /users/123      — удалить                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Проектирование URL

```
┌─────────────────────────────────────────────────────────┐
│                  ПРОЕКТИРОВАНИЕ URL                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✅ ХОРОШО:                                             │
│                                                         │
│  GET  /users                    — коллекция             │
│  GET  /users/123                — элемент               │
│  GET  /users/123/orders         — вложенный ресурс      │
│  GET  /users/123/orders/456     — конкретный заказ      │
│                                                         │
│  ❌ ПЛОХО:                                              │
│                                                         │
│  GET  /getUsers                 — глагол в URL          │
│  GET  /user/123                 — единственное число    │
│  GET  /users/123/getOrders      — глагол                │
│  POST /users/123/delete         — метод в URL           │
│                                                         │
│  Правила:                                               │
│  • Существительные, не глаголы                          │
│  • Множественное число для коллекций                    │
│  • Иерархия через /                                     │
│  • Lowercase, kebab-case                                │
│  • Без расширений (.json, .xml)                         │
│                                                         │
│  Фильтрация и пагинация:                                │
│                                                         │
│  GET /users?status=active&role=admin                    │
│  GET /users?page=2&limit=20                             │
│  GET /users?sort=created_at&order=desc                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### HTTP статус коды

```
┌─────────────────────────────────────────────────────────┐
│                  HTTP СТАТУС КОДЫ                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  2xx — SUCCESS                                          │
│  ─────────────                                          │
│  200 OK          — успех (GET, PUT, PATCH)              │
│  201 Created     — создано (POST)                       │
│  202 Accepted    — принято в обработку (async)          │
│  204 No Content  — успех, нет тела (DELETE)             │
│                                                         │
│  3xx — REDIRECT                                         │
│  ──────────────                                         │
│  301 Moved Permanently — ресурс переехал навсегда       │
│  302 Found            — временный редирект              │
│  304 Not Modified     — кэш актуален                    │
│                                                         │
│  4xx — CLIENT ERROR                                     │
│  ──────────────────                                     │
│  400 Bad Request      — невалидный запрос               │
│  401 Unauthorized     — не аутентифицирован             │
│  403 Forbidden        — нет прав                        │
│  404 Not Found        — ресурс не найден                │
│  409 Conflict         — конфликт (уже существует)       │
│  422 Unprocessable    — валидация не прошла             │
│  429 Too Many Requests— rate limit                      │
│                                                         │
│  5xx — SERVER ERROR                                     │
│  ──────────────────                                     │
│  500 Internal Server Error — ошибка сервера             │
│  502 Bad Gateway          — upstream error              │
│  503 Service Unavailable  — сервис недоступен           │
│  504 Gateway Timeout      — upstream timeout            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## gRPC

```
┌─────────────────────────────────────────────────────────┐
│                        gRPC                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  gRPC = Google Remote Procedure Call                    │
│  Протокол: HTTP/2 + Protocol Buffers                    │
│                                                         │
│  ┌──────────┐    HTTP/2 + Protobuf    ┌──────────┐      │
│  │  Client  │◄───────────────────────►│  Server  │      │
│  │  (stub)  │                         │          │      │
│  └──────────┘                         └──────────┘      │
│                                                         │
│  Определение сервиса (.proto):                          │
│                                                         │
│  service UserService {                                  │
│    rpc GetUser(GetUserRequest) returns (User);          │
│    rpc ListUsers(ListRequest) returns (stream User);    │
│    rpc CreateUser(User) returns (User);                 │
│  }                                                      │
│                                                         │
│  message User {                                         │
│    int64 id = 1;                                        │
│    string name = 2;                                     │
│    string email = 3;                                    │
│  }                                                      │
│                                                         │
│  Типы вызовов:                                          │
│  • Unary: запрос → ответ                                │
│  • Server streaming: запрос → поток ответов             │
│  • Client streaming: поток запросов → ответ             │
│  • Bidirectional: поток ↔ поток                         │
│                                                         │
│  ✅ Плюсы:                                              │
│  • Быстрее REST (бинарный формат)                       │
│  • Строгая типизация                                    │
│  • Streaming                                            │
│  • Генерация кода                                       │
│                                                         │
│  ❌ Минусы:                                             │
│  • Не читаемый формат                                   │
│  • Сложнее отлаживать                                   │
│  • Не работает в браузере напрямую                      │
│                                                         │
│  Когда использовать:                                    │
│  • Микросервисы (внутренняя коммуникация)               │
│  • Высокая нагрузка                                     │
│  • Streaming данных                                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## GraphQL

```
┌─────────────────────────────────────────────────────────┐
│                      GraphQL                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  GraphQL = Query Language for APIs                      │
│  Клиент запрашивает именно то, что нужно                │
│                                                         │
│  REST проблема (Over-fetching):                         │
│  GET /users/123                                         │
│  → { id, name, email, address, phone, ... }             │
│  Нужно только name, но получили всё!                    │
│                                                         │
│  REST проблема (Under-fetching):                        │
│  GET /users/123                                         │
│  GET /users/123/orders                                  │
│  GET /users/123/reviews                                 │
│  3 запроса для одной страницы!                          │
│                                                         │
│  GraphQL решение:                                       │
│                                                         │
│  query {                                                │
│    user(id: 123) {                                      │
│      name                                               │
│      orders {                                           │
│        id                                               │
│        total                                            │
│      }                                                  │
│      reviews {                                          │
│        rating                                           │
│      }                                                  │
│    }                                                    │
│  }                                                      │
│                                                         │
│  1 запрос, получаем ровно то, что нужно!                │
│                                                         │
│  ✅ Плюсы:                                              │
│  • Клиент решает, что получать                          │
│  • Один endpoint                                        │
│  • Строгая типизация (schema)                           │
│  • Интроспекция                                         │
│                                                         │
│  ❌ Минусы:                                             │
│  • Сложность на сервере                                 │
│  • Кэширование сложнее                                  │
│  • N+1 проблема                                         │
│  • Сложнее rate limiting                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Версионирование API

```
┌─────────────────────────────────────────────────────────┐
│                 ВЕРСИОНИРОВАНИЕ API                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Зачем? API меняется, но старые клиенты должны работать │
│                                                         │
│  1. URL PATH                                            │
│     ────────────                                        │
│     GET /v1/users                                       │
│     GET /v2/users                                       │
│                                                         │
│     ✅ Явно, легко маршрутизировать                     │
│     ❌ Не RESTful (версия не ресурс)                    │
│                                                         │
│  2. QUERY PARAMETER                                     │
│     ─────────────────                                   │
│     GET /users?version=1                                │
│     GET /users?version=2                                │
│                                                         │
│     ✅ Опционально                                      │
│     ❌ Легко забыть                                     │
│                                                         │
│  3. HEADER                                              │
│     ────────                                            │
│     GET /users                                          │
│     Accept: application/vnd.api+json;version=2          │
│                                                         │
│     ✅ Чистые URL                                       │
│     ❌ Сложнее тестировать                              │
│                                                         │
│  4. SUBDOMAIN                                           │
│     ──────────                                          │
│     GET https://v1.api.example.com/users                │
│     GET https://v2.api.example.com/users                │
│                                                         │
│     ✅ Полная изоляция                                  │
│     ❌ Инфраструктурная сложность                       │
│                                                         │
│  Рекомендация: URL Path (самый популярный)              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Backward Compatibility

```
┌─────────────────────────────────────────────────────────┐
│              BACKWARD COMPATIBILITY                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Правило: Не ломай старых клиентов!                     │
│                                                         │
│  ✅ БЕЗОПАСНЫЕ ИЗМЕНЕНИЯ:                               │
│  • Добавление нового endpoint                           │
│  • Добавление опционального поля                        │
│  • Добавление нового значения enum                      │
│  • Расширение ограничений (max: 100 → 200)              │
│                                                         │
│  ❌ ЛОМАЮЩИЕ ИЗМЕНЕНИЯ:                                 │
│  • Удаление endpoint                                    │
│  • Удаление поля                                        │
│  • Переименование поля                                  │
│  • Изменение типа поля                                  │
│  • Изменение обязательности (optional → required)       │
│  • Сужение ограничений (max: 200 → 100)                 │
│                                                         │
│  Как делать ломающие изменения:                         │
│                                                         │
│  1. Новая версия API (v1 → v2)                          │
│  2. Deprecation period (6 месяцев)                      │
│  3. Уведомление клиентов                                │
│  4. Мониторинг использования старой версии              │
│  5. Отключение старой версии                            │
│                                                         │
│  Deprecation в ответе:                                  │
│                                                         │
│  HTTP/1.1 200 OK                                        │
│  Deprecation: Sun, 01 Jan 2025 00:00:00 GMT             │
│  Sunset: Sun, 01 Jul 2025 00:00:00 GMT                  │
│  Link: <https://api.example.com/v2>; rel="successor"    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Аутентификация и авторизация

```
┌─────────────────────────────────────────────────────────┐
│            АУТЕНТИФИКАЦИЯ И АВТОРИЗАЦИЯ                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Аутентификация: КТО ты?                                │
│  Авторизация: ЧТО тебе можно?                           │
│                                                         │
│  1. API KEY                                             │
│     ─────────                                           │
│     GET /users                                          │
│     X-API-Key: abc123xyz                                │
│                                                         │
│     ✅ Просто                                           │
│     ❌ Не безопасно (статичный ключ)                    │
│                                                         │
│  2. BASIC AUTH                                          │
│     ───────────                                         │
│     GET /users                                          │
│     Authorization: Basic base64(user:password)          │
│                                                         │
│     ✅ Стандарт                                         │
│     ❌ Пароль в каждом запросе                          │
│                                                         │
│  3. JWT (JSON Web Token)                                │
│     ─────────────────────                               │
│     GET /users                                          │
│     Authorization: Bearer eyJhbGciOiJIUzI1NiIs...       │
│                                                         │
│     Структура: header.payload.signature                 │
│                                                         │
│     ✅ Stateless, содержит claims                       │
│     ❌ Нельзя отозвать до истечения                     │
│                                                         │
│  4. OAuth 2.0                                           │
│     ──────────                                          │
│     Делегированная авторизация                          │
│     "Войти через Google"                                │
│                                                         │
│     ✅ Стандарт, безопасно                              │
│     ❌ Сложно                                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Rate Limiting

```
┌─────────────────────────────────────────────────────────┐
│                    RATE LIMITING                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Зачем? Защита от перегрузки и злоупотреблений          │
│                                                         │
│  Алгоритмы:                                             │
│                                                         │
│  1. FIXED WINDOW                                        │
│     100 запросов в минуту                               │
│     12:00:00 - 12:00:59 → счётчик                       │
│     12:01:00 → сброс                                    │
│                                                         │
│  2. SLIDING WINDOW                                      │
│     Скользящее окно последних 60 секунд                 │
│     Более точный, но сложнее                            │
│                                                         │
│  3. TOKEN BUCKET                                        │
│     Ведро с токенами, пополняется постоянно             │
│     Запрос = 1 токен                                    │
│     Нет токенов = 429                                   │
│                                                         │
│  4. LEAKY BUCKET                                        │
│     Запросы в очередь, обработка с постоянной скоростью │
│                                                         │
│  Ответ при превышении:                                  │
│                                                         │
│  HTTP/1.1 429 Too Many Requests                         │
│  X-RateLimit-Limit: 100                                 │
│  X-RateLimit-Remaining: 0                               │
│  X-RateLimit-Reset: 1609459200                          │
│  Retry-After: 30                                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **REST** | Архитектурный стиль для веб-API |
| **gRPC** | RPC фреймворк от Google (HTTP/2 + Protobuf) |
| **GraphQL** | Query language для API |
| **Идемпотентность** | Повторный вызов = тот же результат |
| **Stateless** | Сервер не хранит состояние клиента |
| **JWT** | JSON Web Token для аутентификации |
| **OAuth** | Протокол делегированной авторизации |
| **Rate Limiting** | Ограничение частоты запросов |
| **Backward Compatible** | Изменения не ломают старых клиентов |
| **Deprecation** | Объявление устаревшим |

---

## REST vs gRPC vs GraphQL

| Характеристика | REST | gRPC | GraphQL |
|----------------|------|------|---------|
| **Формат** | JSON | Protobuf | JSON |
| **Протокол** | HTTP/1.1 | HTTP/2 | HTTP |
| **Типизация** | Нет (OpenAPI) | Строгая | Строгая |
| **Streaming** | Нет | Да | Subscriptions |
| **Браузер** | Да | Нет* | Да |
| **Кэширование** | HTTP cache | Сложно | Сложно |
| **Use case** | Public API | Microservices | Mobile/SPA |

---

## Что запомнить

1. **REST** — стандарт для public API
2. **gRPC** — для внутренних микросервисов (быстрее)
3. **GraphQL** — когда клиенту нужна гибкость
4. **Версионирование через URL** — самый популярный подход
5. **Не ломай старых клиентов** — backward compatibility
6. **Rate limiting обязателен** — защита от перегрузки

---

*Это последний файл дополнительных тем*

