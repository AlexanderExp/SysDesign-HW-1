# 13. Кэширование

> **Сложность:** ⭐⭐ Средний уровень
> **Дополнительная тема** — критически важна для System Design

---

## Зачем нужен кэш?

```
┌─────────────────────────────────────────────────────────┐
│                   ЗАЧЕМ НУЖЕН КЭШ                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: База данных медленная и дорогая              │
│                                                         │
│  ❌ Без кэша:                                           │
│                                                         │
│  User ──► App ──► Database (100ms)                      │
│  User ──► App ──► Database (100ms)                      │
│  User ──► App ──► Database (100ms)                      │
│  ... × 1000 запросов в секунду                          │
│  = 1000 запросов к БД = перегрузка!                     │
│                                                         │
│  ✅ С кэшем:                                            │
│                                                         │
│  User ──► App ──► Cache (1ms) ✓ HIT                     │
│  User ──► App ──► Cache (1ms) ✓ HIT                     │
│  User ──► App ──► Cache ✗ MISS ──► Database (100ms)     │
│  ... × 1000 запросов в секунду                          │
│  = 950 из кэша (1ms) + 50 из БД (100ms)                 │
│  = 95% нагрузки снято с БД!                             │
│                                                         │
│  Преимущества:                                          │
│  • Снижение latency (1ms vs 100ms)                      │
│  • Снижение нагрузки на БД                              │
│  • Экономия денег (БД дорогая)                          │
│  • Повышение throughput                                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Типы кэшей

```
┌─────────────────────────────────────────────────────────┐
│                    ТИПЫ КЭШЕЙ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. CLIENT-SIDE CACHE                                   │
│     Браузер, мобильное приложение                       │
│     HTTP Cache-Control, LocalStorage                    │
│                                                         │
│  2. CDN (Content Delivery Network)                      │
│     Статика ближе к пользователю                        │
│     Cloudflare, CloudFront, Akamai                      │
│                                                         │
│  3. APPLICATION CACHE                                   │
│     In-memory в приложении                              │
│     HashMap, Guava Cache, Caffeine                      │
│                                                         │
│  4. DISTRIBUTED CACHE                                   │
│     Отдельный сервис                                    │
│     Redis, Memcached                                    │
│                                                         │
│  5. DATABASE CACHE                                      │
│     Query cache, Buffer pool                            │
│     Встроен в БД                                        │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │                   ИЕРАРХИЯ                       │    │
│  ├─────────────────────────────────────────────────┤    │
│  │                                                 │    │
│  │  User ──► Browser ──► CDN ──► App ──► Redis ──► DB  │
│  │           Cache      Cache   Cache   Cache   Cache  │
│  │           (L1)       (L2)    (L3)    (L4)    (L5)   │
│  │                                                 │    │
│  │  Ближе к пользователю = быстрее, но меньше     │    │
│  │  Ближе к данным = медленнее, но актуальнее     │    │
│  │                                                 │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Стратегии кэширования

### Cache-Aside (Lazy Loading)

```
┌─────────────────────────────────────────────────────────┐
│                    CACHE-ASIDE                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Приложение само управляет кэшем                        │
│                                                         │
│  ЧТЕНИЕ:                                                │
│  ┌─────────┐  1. get(key)  ┌─────────┐                  │
│  │   App   │──────────────►│  Cache  │                  │
│  │         │◄──────────────│         │                  │
│  └────┬────┘  2. value/nil └─────────┘                  │
│       │                                                 │
│       │ 3. если nil                                     │
│       ▼                                                 │
│  ┌─────────┐                                            │
│  │   DB    │                                            │
│  └────┬────┘                                            │
│       │                                                 │
│       │ 4. value                                        │
│       ▼                                                 │
│  ┌─────────┐  5. set(key, value)  ┌─────────┐           │
│  │   App   │─────────────────────►│  Cache  │           │
│  └─────────┘                      └─────────┘           │
│                                                         │
│  ЗАПИСЬ:                                                │
│  App ──► DB (записать) ──► Cache (удалить или обновить) │
│                                                         │
│  ✅ Плюсы:                                              │
│  • Простая реализация                                   │
│  • Кэшируем только то, что запрашивают                  │
│                                                         │
│  ❌ Минусы:                                             │
│  • Cache miss = медленный первый запрос                 │
│  • Возможна несогласованность                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Write-Through

```
┌─────────────────────────────────────────────────────────┐
│                   WRITE-THROUGH                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Запись идёт через кэш                                  │
│                                                         │
│  ┌─────────┐  1. write  ┌─────────┐  2. write  ┌─────┐  │
│  │   App   │───────────►│  Cache  │───────────►│ DB  │  │
│  │         │◄───────────│         │◄───────────│     │  │
│  └─────────┘  4. OK     └─────────┘  3. OK     └─────┘  │
│                                                         │
│  Кэш синхронно пишет в БД                               │
│                                                         │
│  ✅ Плюсы:                                              │
│  • Кэш всегда актуален                                  │
│  • Простая модель                                       │
│                                                         │
│  ❌ Минусы:                                             │
│  • Медленная запись (ждём БД)                           │
│  • Кэшируем данные, которые могут не читаться           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Write-Behind (Write-Back)

```
┌─────────────────────────────────────────────────────────┐
│                   WRITE-BEHIND                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Запись в БД асинхронная                                │
│                                                         │
│  ┌─────────┐  1. write  ┌─────────┐                     │
│  │   App   │───────────►│  Cache  │                     │
│  │         │◄───────────│         │                     │
│  └─────────┘  2. OK     └────┬────┘                     │
│                              │                          │
│                         (async)                         │
│                              │                          │
│                              ▼                          │
│                         ┌─────────┐                     │
│                         │   DB    │                     │
│                         └─────────┘                     │
│                                                         │
│  ✅ Плюсы:                                              │
│  • Быстрая запись (не ждём БД)                          │
│  • Можно батчить записи                                 │
│                                                         │
│  ❌ Минусы:                                             │
│  • Риск потери данных (кэш упал до записи в БД)         │
│  • Сложная реализация                                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Read-Through

```
┌─────────────────────────────────────────────────────────┐
│                    READ-THROUGH                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Кэш сам загружает данные из БД                         │
│                                                         │
│  ┌─────────┐  1. get(key)  ┌─────────┐                  │
│  │   App   │──────────────►│  Cache  │                  │
│  │         │               │         │                  │
│  │         │               │ (miss?) │                  │
│  │         │               └────┬────┘                  │
│  │         │                    │                       │
│  │         │               2. load from DB              │
│  │         │                    │                       │
│  │         │               ┌────▼────┐                  │
│  │         │               │   DB    │                  │
│  │         │               └────┬────┘                  │
│  │         │                    │                       │
│  │         │◄───────────────────┘                       │
│  └─────────┘  3. value                                  │
│                                                         │
│  Отличие от Cache-Aside:                                │
│  • Cache-Aside: App загружает из БД                     │
│  • Read-Through: Cache загружает из БД                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Сравнение стратегий

| Стратегия | Чтение | Запись | Когда использовать |
|-----------|--------|--------|-------------------|
| **Cache-Aside** | App → Cache → DB | App → DB, invalidate Cache | Общий случай |
| **Read-Through** | App → Cache (→ DB) | - | Упрощение кода |
| **Write-Through** | - | App → Cache → DB (sync) | Консистентность важна |
| **Write-Behind** | - | App → Cache → DB (async) | Высокая нагрузка на запись |

---

## Инвалидация кэша

```
┌─────────────────────────────────────────────────────────┐
│                   ИНВАЛИДАЦИЯ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  "There are only two hard things in Computer Science:   │
│   cache invalidation and naming things."                │
│                                — Phil Karlton            │
│                                                         │
│  Проблема: Когда и как обновлять кэш?                   │
│                                                         │
│  1. TTL (Time To Live)                                  │
│     ─────────────────                                   │
│     cache.set(key, value, ttl=60)  # 60 секунд          │
│                                                         │
│     ✅ Простота                                         │
│     ❌ Данные устаревают до истечения TTL               │
│                                                         │
│  2. ЯВНАЯ ИНВАЛИДАЦИЯ                                   │
│     ───────────────────                                 │
│     При изменении данных:                               │
│     db.update(user)                                     │
│     cache.delete(f"user:{user.id}")                     │
│                                                         │
│     ✅ Данные всегда актуальны                          │
│     ❌ Нужно знать все ключи для инвалидации            │
│                                                         │
│  3. СОБЫТИЙНАЯ ИНВАЛИДАЦИЯ                              │
│     ─────────────────────                               │
│     DB публикует событие → сервис инвалидирует кэш      │
│                                                         │
│     DB ──► Kafka ──► Cache Invalidator ──► Redis        │
│                                                         │
│     ✅ Decoupled                                        │
│     ❌ Сложность, eventual consistency                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Проблемы кэширования

### Cache Stampede (Thundering Herd)

```
┌─────────────────────────────────────────────────────────┐
│                  CACHE STAMPEDE                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Популярный ключ истёк, все идут в БД         │
│                                                         │
│  TTL истёк для "popular_product"                        │
│                                                         │
│  User 1 ──► Cache MISS ──► DB                           │
│  User 2 ──► Cache MISS ──► DB   (одновременно!)         │
│  User 3 ──► Cache MISS ──► DB                           │
│  User 4 ──► Cache MISS ──► DB                           │
│  ...                                                    │
│  1000 запросов к БД за секунду!                         │
│                                                         │
│  Решения:                                               │
│                                                         │
│  1. LOCKING                                             │
│     Только один запрос идёт в БД, остальные ждут        │
│                                                         │
│     lock = redis.setnx("lock:popular_product", 1)       │
│     if lock:                                            │
│         value = db.get()                                │
│         cache.set("popular_product", value)             │
│         redis.delete("lock:popular_product")            │
│     else:                                               │
│         wait and retry from cache                       │
│                                                         │
│  2. PROBABILISTIC EARLY EXPIRATION                      │
│     Обновляем кэш ДО истечения TTL                      │
│                                                         │
│     remaining_ttl = cache.ttl(key)                      │
│     if random() < exp(-remaining_ttl / beta):           │
│         refresh_cache()                                 │
│                                                         │
│  3. BACKGROUND REFRESH                                  │
│     Фоновый процесс обновляет популярные ключи          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Cache Penetration

```
┌─────────────────────────────────────────────────────────┐
│                 CACHE PENETRATION                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Запросы к несуществующим данным              │
│            всегда идут в БД                             │
│                                                         │
│  GET /users/999999999  (не существует)                  │
│                                                         │
│  Cache MISS → DB (not found) → Cache не пишем           │
│  Cache MISS → DB (not found) → Cache не пишем           │
│  ... (каждый раз в БД!)                                 │
│                                                         │
│  Атака: Злоумышленник запрашивает случайные ID          │
│         → DDoS на базу данных                           │
│                                                         │
│  Решения:                                               │
│                                                         │
│  1. CACHE NULL VALUES                                   │
│     Кэшируем "не найдено" с коротким TTL                │
│                                                         │
│     value = db.get(key)                                 │
│     if value is None:                                   │
│         cache.set(key, "NULL", ttl=60)                  │
│     else:                                               │
│         cache.set(key, value, ttl=3600)                 │
│                                                         │
│  2. BLOOM FILTER                                        │
│     Быстрая проверка "точно нет" или "возможно есть"    │
│                                                         │
│     if not bloom_filter.might_contain(key):             │
│         return None  # Точно нет, не идём в БД          │
│     else:                                               │
│         return db.get(key)                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Cache Avalanche

```
┌─────────────────────────────────────────────────────────┐
│                  CACHE AVALANCHE                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Много ключей истекают одновременно           │
│                                                         │
│  12:00:00 — загрузили 10000 ключей с TTL=3600           │
│  13:00:00 — все 10000 ключей истекли одновременно!      │
│           → 10000 запросов к БД                         │
│                                                         │
│  Или: Redis упал → все запросы идут в БД                │
│                                                         │
│  Решения:                                               │
│                                                         │
│  1. RANDOM TTL JITTER                                   │
│     Добавляем случайность к TTL                         │
│                                                         │
│     base_ttl = 3600                                     │
│     jitter = random.randint(-300, 300)  # ±5 минут      │
│     cache.set(key, value, ttl=base_ttl + jitter)        │
│                                                         │
│  2. CACHE WARMING                                       │
│     Предзагрузка кэша при старте                        │
│                                                         │
│  3. FALLBACK TO STALE                                   │
│     Если кэш недоступен — вернуть устаревшие данные     │
│                                                         │
│  4. CIRCUIT BREAKER                                     │
│     Если БД перегружена — fail fast                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Eviction Policies (Политики вытеснения)

```
┌─────────────────────────────────────────────────────────┐
│                 EVICTION POLICIES                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Кэш заполнен, нужно что-то удалить           │
│                                                         │
│  1. LRU (Least Recently Used)                           │
│     Удаляем давно не использованное                     │
│     ✅ Хорошо для большинства случаев                   │
│                                                         │
│  2. LFU (Least Frequently Used)                         │
│     Удаляем редко используемое                          │
│     ✅ Хорошо для стабильных паттернов                  │
│                                                         │
│  3. FIFO (First In First Out)                           │
│     Удаляем старейшее                                   │
│     ✅ Простота                                         │
│                                                         │
│  4. TTL (Time To Live)                                  │
│     Удаляем по истечении времени                        │
│     ✅ Предсказуемость                                  │
│                                                         │
│  5. RANDOM                                              │
│     Удаляем случайное                                   │
│     ✅ Простота, O(1)                                   │
│                                                         │
│  Redis поддерживает:                                    │
│  • volatile-lru — LRU среди ключей с TTL                │
│  • allkeys-lru — LRU среди всех ключей                  │
│  • volatile-lfu — LFU среди ключей с TTL                │
│  • allkeys-lfu — LFU среди всех ключей                  │
│  • volatile-random — случайный среди ключей с TTL       │
│  • allkeys-random — случайный среди всех                │
│  • volatile-ttl — ближайший к истечению TTL             │
│  • noeviction — ошибка при переполнении                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Распределённый кэш

```
┌─────────────────────────────────────────────────────────┐
│              РАСПРЕДЕЛЁННЫЙ КЭШ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Проблема: Один сервер кэша не справляется              │
│                                                         │
│  Решение: Шардирование кэша                             │
│                                                         │
│  ┌─────────┐                                            │
│  │   App   │                                            │
│  └────┬────┘                                            │
│       │                                                 │
│       │  hash(key) % 3                                  │
│       │                                                 │
│  ┌────┴────┬─────────┬─────────┐                        │
│  ▼         ▼         ▼         │                        │
│  ┌─────┐ ┌─────┐ ┌─────┐       │                        │
│  │Redis│ │Redis│ │Redis│       │                        │
│  │  0  │ │  1  │ │  2  │       │                        │
│  └─────┘ └─────┘ └─────┘       │                        │
│                                │                        │
│  Consistent Hashing:           │                        │
│  При добавлении/удалении узла  │                        │
│  перемещается минимум ключей   │                        │
│                                                         │
│  Redis Cluster:                                         │
│  • 16384 слота                                          │
│  • Автоматическое шардирование                          │
│  • Репликация для отказоустойчивости                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **Cache Hit** | Данные найдены в кэше |
| **Cache Miss** | Данные не найдены, идём в БД |
| **Hit Rate** | Процент попаданий в кэш |
| **TTL** | Time To Live — время жизни записи |
| **Eviction** | Вытеснение данных из кэша |
| **LRU** | Least Recently Used — вытеснение давно не использованного |
| **Cache Stampede** | Много запросов к БД при истечении популярного ключа |
| **Cache Penetration** | Запросы к несуществующим данным |
| **Cache Avalanche** | Массовое истечение ключей |
| **Write-Through** | Синхронная запись через кэш |
| **Write-Behind** | Асинхронная запись через кэш |

---

## Что запомнить

1. **Cache-Aside** — самая популярная стратегия
2. **TTL + явная инвалидация** — баланс простоты и актуальности
3. **Cache Stampede** — решай через locking или early refresh
4. **Cache Penetration** — кэшируй NULL или используй Bloom Filter
5. **Random TTL Jitter** — защита от Cache Avalanche
6. **Hit Rate > 90%** — хороший показатель эффективности кэша

---

*Следующий файл: [14. Очереди сообщений](14_message_queues.md)*

