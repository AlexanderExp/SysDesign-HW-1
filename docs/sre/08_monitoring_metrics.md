# 08. Мониторинг и метрики

> **Сложность:** ⭐⭐ Средний уровень
> **Вопросы из списка:** 27, 28, 29, 30

---

## Вопрос 27: Зачем нужен мониторинг?

### Что такое мониторинг?

**Мониторинг** — это процесс сбора, агрегации и анализа данных о состоянии системы.

```
┌─────────────────────────────────────────────────────────┐
│                    МОНИТОРИНГ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │
│  │ Service │  │ Service │  │ Service │                 │
│  │    A    │  │    B    │  │    C    │                 │
│  └────┬────┘  └────┬────┘  └────┬────┘                 │
│       │            │            │                       │
│       │   Метрики  │   Метрики  │                       │
│       └────────────┼────────────┘                       │
│                    ▼                                    │
│            ┌───────────────┐                            │
│            │  Prometheus   │                            │
│            │  (сбор)       │                            │
│            └───────┬───────┘                            │
│                    │                                    │
│            ┌───────▼───────┐                            │
│            │   Grafana     │                            │
│            │ (визуализация)│                            │
│            └───────┬───────┘                            │
│                    │                                    │
│            ┌───────▼───────┐                            │
│            │  Alertmanager │                            │
│            │  (алерты)     │                            │
│            └───────────────┘                            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Зачем нужен мониторинг?

```
┌─────────────────────────────────────────────────────────┐
│                ЦЕЛИ МОНИТОРИНГА                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. ОБНАРУЖЕНИЕ ПРОБЛЕМ                                 │
│     • Узнать о сбое раньше пользователей                │
│     • Увидеть деградацию производительности             │
│     • Заметить аномалии                                 │
│                                                         │
│  2. ДИАГНОСТИКА                                         │
│     • Понять причину проблемы                           │
│     • Найти узкое место                                 │
│     • Отследить изменения                               │
│                                                         │
│  3. ПЛАНИРОВАНИЕ                                        │
│     • Capacity planning (когда нужно больше ресурсов?)  │
│     • Трендовый анализ                                  │
│     • Прогнозирование                                   │
│                                                         │
│  4. БИЗНЕС-МЕТРИКИ                                      │
│     • Сколько заказов в минуту?                         │
│     • Какая конверсия?                                  │
│     • Сколько активных пользователей?                   │
│                                                         │
│  5. ОТЧЁТНОСТЬ                                          │
│     • SLA compliance                                    │
│     • Post-mortem анализ                                │
│     • Аудит                                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Что мониторить?

```
┌─────────────────────────────────────────────────────────┐
│                  ЧТО МОНИТОРИТЬ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ИНФРАСТРУКТУРА:                                        │
│  • CPU, Memory, Disk, Network                           │
│  • Контейнеры, поды                                     │
│  • Базы данных                                          │
│  • Очереди сообщений                                    │
│                                                         │
│  ПРИЛОЖЕНИЕ:                                            │
│  • Request rate (RPS)                                   │
│  • Error rate                                           │
│  • Latency (p50, p95, p99)                              │
│  • Saturation (насыщение)                               │
│                                                         │
│  БИЗНЕС:                                                │
│  • Заказы, платежи, регистрации                         │
│  • Конверсия                                            │
│  • Revenue                                              │
│                                                         │
│  Правило: Мониторь то, что влияет на пользователей!     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Вопрос 28: Что такое метрики? Какие бывают типы?

### Что такое метрика?

**Метрика** — это числовое значение, описывающее какой-то аспект системы в момент времени.

```
┌─────────────────────────────────────────────────────────┐
│                     МЕТРИКА                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Структура метрики:                                     │
│                                                         │
│  http_requests_total{method="GET", status="200"} 12345  │
│  ─────────────────── ─────────────────────────── ─────  │
│        Имя                   Labels              Value  │
│                                                         │
│  • Имя: Что измеряем                                    │
│  • Labels: Дополнительные измерения (теги)              │
│  • Value: Числовое значение                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Типы метрик

#### 1. Counter (счётчик)

```
┌─────────────────────────────────────────────────────────┐
│                      COUNTER                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Что это: Монотонно растущее значение                   │
│  Может только: Увеличиваться или сбрасываться в 0       │
│                                                         │
│  │                                    ▄▄▄▄▄▄▄▄▄         │
│  │                           ▄▄▄▄▄▄▄▄█████████         │
│  │                  ▄▄▄▄▄▄▄▄█████████████████         │
│  │         ▄▄▄▄▄▄▄█████████████████████████         │
│  │▄▄▄▄▄▄▄▄█████████████████████████████████         │
│  └─────────────────────────────────────────► время      │
│                                                         │
│  Примеры:                                               │
│  • http_requests_total — всего запросов                 │
│  • errors_total — всего ошибок                          │
│  • bytes_sent_total — всего байт отправлено             │
│                                                         │
│  Как использовать:                                      │
│  rate(http_requests_total[5m]) — запросов в секунду     │
│  increase(errors_total[1h]) — ошибок за час             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2. Gauge (измеритель)

```
┌─────────────────────────────────────────────────────────┐
│                       GAUGE                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Что это: Значение, которое может расти и падать        │
│  Показывает: Текущее состояние                          │
│                                                         │
│  │      ▄▄                     ▄▄▄                      │
│  │    ▄████▄                 ▄█████▄                    │
│  │  ▄████████▄             ▄█████████▄                  │
│  │▄████████████▄▄▄▄▄▄▄▄▄▄▄██████████████▄              │
│  └─────────────────────────────────────────► время      │
│                                                         │
│  Примеры:                                               │
│  • temperature — температура                            │
│  • memory_usage_bytes — использование памяти            │
│  • active_connections — активные соединения             │
│  • queue_size — размер очереди                          │
│                                                         │
│  Как использовать:                                      │
│  memory_usage_bytes — текущее значение                  │
│  max_over_time(cpu_usage[1h]) — максимум за час         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3. Histogram (гистограмма)

```
┌─────────────────────────────────────────────────────────┐
│                     HISTOGRAM                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Что это: Распределение значений по бакетам (buckets)   │
│  Показывает: Сколько значений попало в каждый диапазон  │
│                                                         │
│  Латентность запросов:                                  │
│                                                         │
│  Бакеты:    <10ms  <50ms  <100ms <500ms <1s   >1s       │
│             ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐   │
│  Кол-во:    │████│ │████│ │██  │ │█   │ │    │ │    │   │
│             │████│ │████│ │██  │ │█   │ │    │ │    │   │
│             │████│ │████│ │██  │ │█   │ │    │ │    │   │
│             └────┘ └────┘ └────┘ └────┘ └────┘ └────┘   │
│  Запросов:   5000   3000   1500   400    80     20      │
│                                                         │
│  Метрики создаются автоматически:                       │
│  • request_duration_bucket{le="0.01"} — ≤10ms           │
│  • request_duration_bucket{le="0.05"} — ≤50ms           │
│  • request_duration_sum — сумма всех значений           │
│  • request_duration_count — количество наблюдений       │
│                                                         │
│  Как использовать:                                      │
│  histogram_quantile(0.95, rate(...)) — p95 латентность  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 4. Summary (сводка)

```
┌─────────────────────────────────────────────────────────┐
│                      SUMMARY                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Что это: Похоже на Histogram, но считает квантили      │
│           на стороне клиента                            │
│                                                         │
│  Метрики:                                               │
│  • request_duration{quantile="0.5"} — медиана           │
│  • request_duration{quantile="0.9"} — p90               │
│  • request_duration{quantile="0.99"} — p99              │
│  • request_duration_sum                                 │
│  • request_duration_count                               │
│                                                         │
│  Histogram vs Summary:                                  │
│  ┌─────────────────┬────────────────┬─────────────────┐ │
│  │                 │   Histogram    │    Summary      │ │
│  ├─────────────────┼────────────────┼─────────────────┤ │
│  │ Квантили        │ На сервере     │ На клиенте      │ │
│  │ Агрегация       │ Можно          │ Нельзя          │ │
│  │ Точность        │ Зависит от     │ Настраиваемая   │ │
│  │                 │ бакетов        │                 │ │
│  │ CPU на клиенте  │ Низкая         │ Высокая         │ │
│  └─────────────────┴────────────────┴─────────────────┘ │
│                                                         │
│  Рекомендация: Используй Histogram (можно агрегировать) │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Сравнение типов метрик

| Тип | Что измеряет | Пример | Операции |
|-----|--------------|--------|----------|
| **Counter** | Накопленное количество | Запросы, ошибки | rate(), increase() |
| **Gauge** | Текущее значение | CPU, память, очередь | Прямое значение |
| **Histogram** | Распределение | Латентность | histogram_quantile() |
| **Summary** | Квантили | Латентность | Прямые квантили |

---

## Вопрос 29: Быстро меняющиеся значения (Connection Pool)

### Проблема

```
┌─────────────────────────────────────────────────────────┐
│                     ПРОБЛЕМА                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Connection Pool: 100 соединений                        │
│  Метрика: active_connections                            │
│                                                         │
│  Значение меняется ОЧЕНЬ быстро:                        │
│                                                         │
│  T=0.000: 45 соединений                                 │
│  T=0.001: 47 соединений                                 │
│  T=0.002: 43 соединений                                 │
│  T=0.003: 52 соединений                                 │
│  ...                                                    │
│                                                         │
│  Prometheus scrape interval: 15 секунд                  │
│  → Мы видим только 1 значение из 15000!                 │
│                                                         │
│  │    ?    ?    ?    ?    ?    ?                        │
│  │    ●    ●    ●    ●    ●    ●    ← Что мы видим      │
│  │▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄  ← Реальность       │
│  └─────────────────────────────────► время              │
│                                                         │
│  Проблема: Пропускаем пики и провалы!                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Решения

#### 1. Использовать Histogram/Summary

```
┌─────────────────────────────────────────────────────────┐
│              HISTOGRAM ДЛЯ GAUGE-LIKE ДАННЫХ            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Вместо одного значения — распределение за период       │
│                                                         │
│  Каждую миллисекунду:                                   │
│  observe(active_connections)                            │
│                                                         │
│  Результат за 15 секунд:                                │
│  • min: 30                                              │
│  • max: 95                                              │
│  • avg: 52                                              │
│  • p50: 48                                              │
│  • p99: 90                                              │
│                                                         │
│  Теперь видим полную картину!                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2. Экспонировать min/max/avg

```
┌─────────────────────────────────────────────────────────┐
│                  MIN / MAX / AVG                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Приложение само считает статистику между scrapes:      │
│                                                         │
│  connection_pool_active_min 30                          │
│  connection_pool_active_max 95                          │
│  connection_pool_active_avg 52                          │
│  connection_pool_active_current 48                      │
│                                                         │
│  При каждом scrape — сбрасываем min/max/avg             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3. Уменьшить scrape interval

```
┌─────────────────────────────────────────────────────────┐
│               УМЕНЬШИТЬ ИНТЕРВАЛ                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  scrape_interval: 15s → 1s                              │
│                                                         │
│  ⚠️ Проблемы:                                           │
│  • Больше данных → больше хранилища                     │
│  • Больше нагрузки на Prometheus                        │
│  • Всё равно не увидим миллисекундные изменения         │
│                                                         │
│  Когда использовать:                                    │
│  • Критичные метрики                                    │
│  • Короткоживущие процессы                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 4. Push вместо Pull

```
┌─────────────────────────────────────────────────────────┐
│                    PUSH МОДЕЛЬ                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Вместо: Prometheus забирает метрики                    │
│  Делаем: Приложение отправляет метрики                  │
│                                                         │
│  ┌─────────┐   push    ┌─────────────┐                  │
│  │   App   │──────────►│ Pushgateway │                  │
│  └─────────┘           └─────────────┘                  │
│                              │                          │
│                        pull  │                          │
│                              ▼                          │
│                       ┌─────────────┐                   │
│                       │ Prometheus  │                   │
│                       └─────────────┘                   │
│                                                         │
│  Или: StatsD, InfluxDB, Datadog (push-native)           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Рекомендации

```
┌─────────────────────────────────────────────────────────┐
│                   РЕКОМЕНДАЦИИ                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Для быстро меняющихся значений:                        │
│                                                         │
│  1. Экспонируй min/max/avg между scrapes                │
│  2. Используй Histogram для распределения               │
│  3. Настрой алерты на max, а не на текущее значение     │
│  4. Для критичных метрик — уменьши scrape interval      │
│                                                         │
│  Пример для Connection Pool:                            │
│                                                         │
│  db_pool_connections_active        48   (gauge, текущее)│
│  db_pool_connections_active_max    95   (gauge, макс)   │
│  db_pool_connections_active_min    30   (gauge, мин)    │
│  db_pool_connections_total         100  (gauge, всего)  │
│  db_pool_connections_waiting       5    (gauge, в ожид.)│
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Вопрос 30: Кардинальность метрик

### Что такое кардинальность?

**Кардинальность (Cardinality)** — это количество уникальных комбинаций labels для метрики.

```
┌─────────────────────────────────────────────────────────┐
│                   КАРДИНАЛЬНОСТЬ                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Метрика: http_requests_total{method, status, endpoint} │
│                                                         │
│  Низкая кардинальность:                                 │
│  • method: GET, POST, PUT, DELETE (4 значения)          │
│  • status: 200, 400, 500 (3 значения)                   │
│  → 4 × 3 = 12 временных рядов                           │
│                                                         │
│  Высокая кардинальность:                                │
│  • endpoint: /users/123, /users/456, ... (миллионы!)    │
│  → 4 × 3 × 1,000,000 = 12,000,000 временных рядов!      │
│                                                         │
│  ⚠️ Каждый временной ряд = память + CPU + диск          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Почему высокая кардинальность опасна?

```
┌─────────────────────────────────────────────────────────┐
│              ОПАСНОСТЬ ВЫСОКОЙ КАРДИНАЛЬНОСТИ           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. ПАМЯТЬ                                              │
│     Prometheus хранит активные ряды в RAM               │
│     1M рядов × 1KB = 1GB RAM только на метрики!         │
│                                                         │
│  2. ПРОИЗВОДИТЕЛЬНОСТЬ                                  │
│     Запрос rate(http_requests_total[5m])                │
│     должен обработать ВСЕ временные ряды                │
│                                                         │
│  3. ХРАНЕНИЕ                                            │
│     Больше рядов = больше данных на диске               │
│                                                         │
│  4. СТОИМОСТЬ                                           │
│     Cloud-мониторинг (Datadog, New Relic) берёт         │
│     деньги за количество метрик!                        │
│                                                         │
│  Типичные ошибки:                                       │
│  ❌ user_id в labels (миллионы пользователей)           │
│  ❌ request_id в labels (уникален для каждого запроса)  │
│  ❌ timestamp в labels (бесконечно растёт)              │
│  ❌ email в labels (уникален)                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Как избежать проблем?

```
┌─────────────────────────────────────────────────────────┐
│                    РЕШЕНИЯ                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. НЕ ИСПОЛЬЗУЙ ВЫСОКОКАРДИНАЛЬНЫЕ LABELS              │
│                                                         │
│  ❌ http_requests{user_id="123"}                        │
│  ✅ http_requests{user_type="premium"}                  │
│                                                         │
│  ❌ http_requests{endpoint="/users/123"}                │
│  ✅ http_requests{endpoint="/users/:id"}                │
│                                                         │
│  2. АГРЕГИРУЙ НА СТОРОНЕ ПРИЛОЖЕНИЯ                     │
│                                                         │
│  Вместо метрики на каждого пользователя:                │
│  → Считай общую статистику                              │
│  → Используй Histogram для распределения                │
│                                                         │
│  3. ИСПОЛЬЗУЙ ЛОГИ ДЛЯ ВЫСОКОКАРДИНАЛЬНЫХ ДАННЫХ        │
│                                                         │
│  Метрики: Сколько ошибок? (counter)                     │
│  Логи: Какой user_id получил ошибку? (structured log)   │
│                                                         │
│  4. МОНИТОРЬ КАРДИНАЛЬНОСТЬ                             │
│                                                         │
│  prometheus_tsdb_head_series — количество активных рядов│
│  Алерт: если > 1M — расследуй!                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Правила именования labels

```
┌─────────────────────────────────────────────────────────┐
│                  ПРАВИЛА LABELS                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✅ ХОРОШИЕ LABELS (низкая кардинальность):             │
│  • method: GET, POST, PUT, DELETE                       │
│  • status_code: 200, 400, 500                           │
│  • service: auth, billing, rental                       │
│  • environment: prod, staging, dev                      │
│  • region: us-east, eu-west                             │
│  • version: v1, v2                                      │
│                                                         │
│  ❌ ПЛОХИЕ LABELS (высокая кардинальность):             │
│  • user_id: 1, 2, 3, ... (миллионы)                     │
│  • request_id: uuid (уникален)                          │
│  • timestamp: 1234567890 (бесконечно)                   │
│  • email: user@example.com (уникален)                   │
│  • ip_address: 1.2.3.4 (много)                          │
│                                                         │
│  Правило: Label должен иметь < 100 уникальных значений  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **Мониторинг** | Сбор и анализ данных о состоянии системы |
| **Метрика** | Числовое значение, описывающее аспект системы |
| **Counter** | Метрика, которая только растёт |
| **Gauge** | Метрика, которая может расти и падать |
| **Histogram** | Распределение значений по бакетам |
| **Summary** | Квантили, посчитанные на клиенте |
| **Label** | Дополнительное измерение метрики (тег) |
| **Кардинальность** | Количество уникальных комбинаций labels |
| **Scrape** | Процесс сбора метрик Prometheus |

---

## Что запомнить

1. **Мониторинг нужен для:** обнаружения проблем, диагностики, планирования
2. **Counter для накопленных значений**, Gauge для текущих
3. **Histogram лучше Summary** — можно агрегировать
4. **Для быстро меняющихся значений** — экспонируй min/max/avg
5. **Избегай высокой кардинальности** — не используй user_id в labels
6. **Правило:** Label должен иметь < 100 уникальных значений

---

*Следующий файл: [09. Логирование и трассировка](09_logging_tracing.md)*