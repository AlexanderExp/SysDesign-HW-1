# 06. Микросервисы и распределённые транзакции

> **Сложность:** ⭐⭐⭐ Продвинутый уровень
> **Вопросы из списка:** 10, 11, 12

---

## Вопрос 10: Преимущества и недостатки микросервисов

### Что такое микросервисы?

**Микросервисная архитектура** — это способ построения приложения из маленьких, независимых сервисов.

```
┌─────────────────────────────────────────────────────────┐
│              МОНОЛИТ vs МИКРОСЕРВИСЫ                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  МОНОЛИТ:                                               │
│  ┌─────────────────────────────────────┐                │
│  │           Одно приложение           │                │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │                │
│  │  │Users│ │Order│ │Pay  │ │Ship │   │                │
│  │  └─────┘ └─────┘ └─────┘ └─────┘   │                │
│  │         Общая БД, общий код         │                │
│  └─────────────────────────────────────┘                │
│                                                         │
│  МИКРОСЕРВИСЫ:                                          │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐            │
│  │ Users │  │ Order │  │  Pay  │  │ Ship  │            │
│  │Service│  │Service│  │Service│  │Service│            │
│  └───┬───┘  └───┬───┘  └───┬───┘  └───┬───┘            │
│      │          │          │          │                 │
│    ┌─┴─┐      ┌─┴─┐      ┌─┴─┐      ┌─┴─┐              │
│    │DB │      │DB │      │DB │      │DB │              │
│    └───┘      └───┘      └───┘      └───┘              │
│    Каждый сервис — отдельное приложение со своей БД     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Преимущества микросервисов

#### 1. Независимый деплой

```
┌─────────────────────────────────────────────────────────┐
│                 НЕЗАВИСИМЫЙ ДЕПЛОЙ                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит:                                               │
│  Изменил Users → Деплой ВСЕГО приложения → Риск!        │
│                                                         │
│  Микросервисы:                                          │
│  Изменил Users → Деплой ТОЛЬКО Users Service            │
│                                                         │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐            │
│  │ Users │  │ Order │  │  Pay  │  │ Ship  │            │
│  │ v2.0  │  │ v1.5  │  │ v1.2  │  │ v1.0  │            │
│  │  NEW! │  │       │  │       │  │       │            │
│  └───────┘  └───────┘  └───────┘  └───────┘            │
│                                                         │
│  ✅ Быстрее релизы                                      │
│  ✅ Меньше риск                                         │
│  ✅ Проще откат                                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2. Масштабирование по частям

```
┌─────────────────────────────────────────────────────────┐
│              ГРАНУЛЯРНОЕ МАСШТАБИРОВАНИЕ                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит: Нагрузка на Order → Масштабируем ВСЁ          │
│                                                         │
│  Микросервисы: Нагрузка на Order → Масштабируем Order   │
│                                                         │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐            │
│  │ Users │  │ Order │  │  Pay  │  │ Ship  │            │
│  │  x1   │  │  x5   │  │  x2   │  │  x1   │            │
│  └───────┘  └───────┘  └───────┘  └───────┘            │
│             ▲▲▲▲▲                                       │
│             5 инстансов Order, остальные по 1-2         │
│                                                         │
│  ✅ Экономия ресурсов                                   │
│  ✅ Оптимальное использование                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3. Технологическая свобода

```
┌─────────────────────────────────────────────────────────┐
│              ТЕХНОЛОГИЧЕСКАЯ СВОБОДА                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Каждый сервис может использовать свой стек:            │
│                                                         │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐           │
│  │   Users   │  │   Order   │  │    ML     │           │
│  │   Python  │  │    Go     │  │  Python   │           │
│  │  Postgres │  │   MySQL   │  │  MongoDB  │           │
│  └───────────┘  └───────────┘  └───────────┘           │
│                                                         │
│  ✅ Лучший инструмент для задачи                        │
│  ✅ Можно экспериментировать                            │
│  ✅ Легче нанимать (разные команды)                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 4. Изоляция сбоев

```
┌─────────────────────────────────────────────────────────┐
│                  ИЗОЛЯЦИЯ СБОЕВ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит: Упал Payment → Упало ВСЁ приложение           │
│                                                         │
│  Микросервисы: Упал Payment → Остальное работает        │
│                                                         │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐            │
│  │ Users │  │ Order │  │  Pay  │  │ Ship  │            │
│  │  OK   │  │  OK   │  │ DOWN! │  │  OK   │            │
│  └───────┘  └───────┘  └───────┘  └───────┘            │
│                                                         │
│  Пользователи могут:                                    │
│  ✅ Смотреть каталог                                    │
│  ✅ Добавлять в корзину                                 │
│  ❌ Оплачивать (временно)                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Недостатки микросервисов

#### 1. Сложность распределённой системы

```
┌─────────────────────────────────────────────────────────┐
│                    СЛОЖНОСТЬ                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Новые проблемы:                                        │
│  • Сеть ненадёжна (таймауты, потери)                    │
│  • Распределённые транзакции                            │
│  • Согласованность данных                               │
│  • Service discovery                                    │
│  • Версионирование API                                  │
│                                                         │
│  Монолит: user.getOrders() — вызов метода               │
│  Микросервисы: HTTP/gRPC → сеть → сервис → БД           │
│                                                         │
│  ❌ Больше точек отказа                                 │
│  ❌ Сложнее отладка                                     │
│  ❌ Нужна инфраструктура                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2. Операционная сложность

```
┌─────────────────────────────────────────────────────────┐
│               ОПЕРАЦИОННАЯ СЛОЖНОСТЬ                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит: 1 приложение, 1 деплой, 1 лог                 │
│                                                         │
│  Микросервисы (50 сервисов):                            │
│  • 50 репозиториев                                      │
│  • 50 CI/CD пайплайнов                                  │
│  • 50 мониторингов                                      │
│  • 50 × N инстансов                                     │
│                                                         │
│  Нужно:                                                 │
│  • Kubernetes / оркестрация                             │
│  • Централизованные логи (ELK)                          │
│  • Distributed tracing (Jaeger)                         │
│  • Service mesh (Istio)                                 │
│                                                         │
│  ❌ Высокий порог входа                                 │
│  ❌ Дорогая инфраструктура                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3. Сетевые задержки

```
┌─────────────────────────────────────────────────────────┐
│                  СЕТЕВЫЕ ЗАДЕРЖКИ                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит:                                               │
│  getOrder() → 1ms (вызов метода)                        │
│                                                         │
│  Микросервисы:                                          │
│  getOrder() → HTTP → сеть → сервис → БД → обратно       │
│             = 10-50ms                                   │
│                                                         │
│  Цепочка вызовов:                                       │
│  API → Users → Orders → Inventory → Pricing             │
│  = 4 × 20ms = 80ms минимум!                             │
│                                                         │
│  ❌ Выше латентность                                    │
│  ❌ Нужно оптимизировать (кэш, batch, async)            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 4. Согласованность данных

```
┌─────────────────────────────────────────────────────────┐
│              СОГЛАСОВАННОСТЬ ДАННЫХ                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Монолит: Одна БД, одна транзакция                      │
│                                                         │
│  BEGIN;                                                 │
│    INSERT INTO orders ...                               │
│    UPDATE inventory ...                                 │
│    INSERT INTO payments ...                             │
│  COMMIT;  ← Всё или ничего!                             │
│                                                         │
│  Микросервисы: Разные БД, нет транзакции!               │
│                                                         │
│  Order Service → создал заказ ✓                         │
│  Inventory Service → уменьшил остаток ✓                 │
│  Payment Service → ОШИБКА! ✗                            │
│                                                         │
│  Что делать с заказом и остатком?!                      │
│                                                         │
│  ❌ Нужны Saga / 2PC                                    │
│  ❌ Eventual consistency                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Когда использовать микросервисы?

```
┌─────────────────────────────────────────────────────────┐
│              КОГДА ИСПОЛЬЗОВАТЬ                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✅ ИСПОЛЬЗУЙ микросервисы когда:                       │
│  • Большая команда (10+ разработчиков)                  │
│  • Разные части системы масштабируются по-разному       │
│  • Нужна независимость команд                           │
│  • Высокая нагрузка, нужна отказоустойчивость           │
│  • Разные технологии для разных задач                   │
│                                                         │
│  ❌ НЕ ИСПОЛЬЗУЙ микросервисы когда:                    │
│  • Маленькая команда (< 5 человек)                      │
│  • Стартап, MVP, прототип                               │
│  • Нет опыта с распределёнными системами                │
│  • Домен ещё не понятен                                 │
│                                                         │
│  Правило: "Если сомневаешься — начни с монолита"        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Вопрос 11: Two-Phase Commit (2PC)

### Проблема: Распределённая транзакция

```
┌─────────────────────────────────────────────────────────┐
│              ПРОБЛЕМА: АТОМАРНОСТЬ                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Задача: Перевод денег между банками                    │
│                                                         │
│  Банк A: Списать $100 с Alice                           │
│  Банк B: Зачислить $100 на Bob                          │
│                                                         │
│  Требование: Либо ОБА действия, либо НИ ОДНОГО          │
│                                                         │
│  Проблема: Разные БД, разные серверы!                   │
│                                                         │
│  ┌─────────┐              ┌─────────┐                   │
│  │ Bank A  │              │ Bank B  │                   │
│  │  -$100  │              │  +$100  │                   │
│  └─────────┘              └─────────┘                   │
│       ✓                        ✗                        │
│                                                         │
│  Что если Bank B упал? Alice потеряла деньги!           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Решение: Two-Phase Commit (2PC)

**2PC** — протокол для атомарных распределённых транзакций.

```
┌─────────────────────────────────────────────────────────┐
│                    TWO-PHASE COMMIT                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Участники:                                             │
│  • Coordinator (координатор) — управляет транзакцией    │
│  • Participants (участники) — выполняют операции        │
│                                                         │
│              ┌─────────────┐                            │
│              │ Coordinator │                            │
│              └──────┬──────┘                            │
│                     │                                   │
│         ┌───────────┼───────────┐                       │
│         ▼           ▼           ▼                       │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│    │ Bank A  │ │ Bank B  │ │ Bank C  │                 │
│    │(Particip)│ │(Particip)│ │(Particip)│                │
│    └─────────┘ └─────────┘ └─────────┘                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Фаза 1: Prepare (Голосование)

```
┌─────────────────────────────────────────────────────────┐
│                 ФАЗА 1: PREPARE                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Coordinator: "Можете ли вы выполнить операцию?"        │
│                                                         │
│              ┌─────────────┐                            │
│              │ Coordinator │                            │
│              └──────┬──────┘                            │
│                     │                                   │
│            PREPARE? │ PREPARE?                          │
│         ┌───────────┼───────────┐                       │
│         ▼           ▼           ▼                       │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│    │ Bank A  │ │ Bank B  │ │ Bank C  │                 │
│    └────┬────┘ └────┬────┘ └────┬────┘                 │
│         │           │           │                       │
│      Проверяет:  Проверяет:  Проверяет:                 │
│      - Есть $100?  - Счёт OK?  - Лимиты OK?            │
│         │           │           │                       │
│        YES         YES         YES                      │
│         │           │           │                       │
│         └───────────┴───────────┘                       │
│                     │                                   │
│              ┌──────▼──────┐                            │
│              │ Coordinator │                            │
│              │ Все сказали │                            │
│              │    YES!     │                            │
│              └─────────────┘                            │
│                                                         │
│  ⚠️ После YES участник ОБЯЗАН быть готов к COMMIT       │
│     Он залочил ресурсы и записал в лог                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Фаза 2: Commit (Фиксация)

```
┌─────────────────────────────────────────────────────────┐
│                 ФАЗА 2: COMMIT                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Если ВСЕ сказали YES:                                  │
│                                                         │
│              ┌─────────────┐                            │
│              │ Coordinator │                            │
│              │   COMMIT!   │                            │
│              └──────┬──────┘                            │
│                     │                                   │
│             COMMIT  │  COMMIT                           │
│         ┌───────────┼───────────┐                       │
│         ▼           ▼           ▼                       │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│    │ Bank A  │ │ Bank B  │ │ Bank C  │                 │
│    │ COMMIT  │ │ COMMIT  │ │ COMMIT  │                 │
│    │   ✓     │ │   ✓     │ │   ✓     │                 │
│    └─────────┘ └─────────┘ └─────────┘                 │
│                                                         │
│  Если ХОТЬ ОДИН сказал NO:                              │
│                                                         │
│              ┌─────────────┐                            │
│              │ Coordinator │                            │
│              │   ABORT!    │                            │
│              └──────┬──────┘                            │
│                     │                                   │
│             ABORT   │  ABORT                            │
│         ┌───────────┼───────────┐                       │
│         ▼           ▼           ▼                       │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│    │ Bank A  │ │ Bank B  │ │ Bank C  │                 │
│    │ ROLLBACK│ │ ROLLBACK│ │ ROLLBACK│                 │
│    └─────────┘ └─────────┘ └─────────┘                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Проблемы 2PC

```
┌─────────────────────────────────────────────────────────┐
│                   ПРОБЛЕМЫ 2PC                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. БЛОКИРОВКА (Blocking)                               │
│     После PREPARE участники держат локи                 │
│     Если координатор умер — локи навсегда!              │
│                                                         │
│     ┌─────────────┐                                     │
│     │ Coordinator │ ← УМЕР после PREPARE!               │
│     │    DEAD     │                                     │
│     └─────────────┘                                     │
│            │                                            │
│     ┌──────┴──────┐                                     │
│     ▼             ▼                                     │
│  ┌─────────┐ ┌─────────┐                               │
│  │ Bank A  │ │ Bank B  │                               │
│  │ WAITING │ │ WAITING │ ← Ждут COMMIT или ABORT       │
│  │ LOCKED! │ │ LOCKED! │   Ресурсы заблокированы!      │
│  └─────────┘ └─────────┘                               │
│                                                         │
│  2. SINGLE POINT OF FAILURE                             │
│     Координатор — единая точка отказа                   │
│                                                         │
│  3. ВЫСОКАЯ ЛАТЕНТНОСТЬ                                 │
│     2 раунда сетевых вызовов                            │
│     + Синхронные записи в лог                           │
│                                                         │
│  4. НЕ МАСШТАБИРУЕТСЯ                                   │
│     Чем больше участников — тем выше вероятность сбоя   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Когда использовать 2PC?

```
┌─────────────────────────────────────────────────────────┐
│              КОГДА ИСПОЛЬЗОВАТЬ 2PC                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✅ Используй когда:                                    │
│  • Нужна СТРОГАЯ консистентность                        │
│  • Мало участников (2-3)                                │
│  • Внутри одного датацентра (низкая латентность)        │
│  • Можешь позволить блокировки                          │
│                                                         │
│  ❌ Не используй когда:                                 │
│  • Много участников                                     │
│  • Высокая нагрузка                                     │
│  • Географически распределённая система                 │
│  • Нужна высокая доступность                            │
│                                                         │
│  Альтернатива: Saga Pattern                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Вопрос 12: Saga Pattern

### Что такое Saga?

**Saga** — это последовательность локальных транзакций, где каждая транзакция обновляет данные в одном сервисе.

```
┌─────────────────────────────────────────────────────────┐
│                      SAGA                               │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Вместо одной большой транзакции:                       │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │  BEGIN                                          │    │
│  │    Order + Inventory + Payment                  │    │
│  │  COMMIT                                         │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Делаем цепочку маленьких:                              │
│                                                         │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐               │
│  │ T1      │──►│ T2      │──►│ T3      │               │
│  │ Order   │   │Inventory│   │ Payment │               │
│  │ (local) │   │ (local) │   │ (local) │               │
│  └─────────┘   └─────────┘   └─────────┘               │
│                                                         │
│  Если T3 упал — откатываем через компенсации:           │
│                                                         │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐               │
│  │ C1      │◄──│ C2      │◄──│ T3 FAIL │               │
│  │ Cancel  │   │ Restore │   │         │               │
│  │ Order   │   │Inventory│   │         │               │
│  └─────────┘   └─────────┘   └─────────┘               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Компенсирующие транзакции

```
┌─────────────────────────────────────────────────────────┐
│              КОМПЕНСИРУЮЩИЕ ТРАНЗАКЦИИ                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Для каждой транзакции Ti есть компенсация Ci:          │
│                                                         │
│  Транзакция          │  Компенсация                     │
│  ────────────────────┼──────────────────────            │
│  Создать заказ       │  Отменить заказ                  │
│  Списать со склада   │  Вернуть на склад                │
│  Списать деньги      │  Вернуть деньги                  │
│  Отправить товар     │  Вернуть товар (сложно!)         │
│                                                         │
│  ⚠️ Компенсация — это НЕ rollback!                      │
│     Это новая транзакция, которая "отменяет" эффект     │
│                                                         │
│  Пример:                                                │
│  • Rollback: DELETE FROM orders WHERE id=123            │
│  • Компенсация: INSERT INTO orders (status='CANCELLED') │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Реализация 1: Choreography (Хореография)

```
┌─────────────────────────────────────────────────────────┐
│                   CHOREOGRAPHY                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Сервисы общаются через события (events)                │
│  Нет центрального координатора                          │
│                                                         │
│  ┌─────────┐  OrderCreated  ┌─────────┐                │
│  │ Order   │───────────────►│Inventory│                │
│  │ Service │                │ Service │                │
│  └─────────┘                └────┬────┘                │
│       ▲                          │                      │
│       │                   InventoryReserved             │
│       │                          │                      │
│       │                          ▼                      │
│       │                    ┌─────────┐                 │
│       │                    │ Payment │                 │
│       │                    │ Service │                 │
│       │                    └────┬────┘                 │
│       │                          │                      │
│       │                   PaymentCompleted              │
│       │                          │                      │
│       └──────────────────────────┘                      │
│                                                         │
│  При ошибке — события компенсации:                      │
│                                                         │
│  Payment Failed → InventoryReleased → OrderCancelled    │
│                                                         │
│  ✅ Плюсы: Простота, слабая связанность                 │
│  ❌ Минусы: Сложно отследить, циклические зависимости   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Реализация 2: Orchestration (Оркестрация)

```
┌─────────────────────────────────────────────────────────┐
│                   ORCHESTRATION                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Центральный оркестратор управляет Saga                 │
│                                                         │
│                 ┌──────────────┐                        │
│                 │  Saga        │                        │
│                 │ Orchestrator │                        │
│                 └──────┬───────┘                        │
│                        │                                │
│        ┌───────────────┼───────────────┐                │
│        │               │               │                │
│        ▼               ▼               ▼                │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐            │
│   │ Order   │    │Inventory│    │ Payment │            │
│   │ Service │    │ Service │    │ Service │            │
│   └─────────┘    └─────────┘    └─────────┘            │
│                                                         │
│  Оркестратор:                                           │
│  1. Вызывает Order.create()                             │
│  2. Вызывает Inventory.reserve()                        │
│  3. Вызывает Payment.charge()                           │
│  4. Если ошибка — вызывает компенсации                  │
│                                                         │
│  ✅ Плюсы: Легко понять, централизованная логика        │
│  ❌ Минусы: Оркестратор — точка отказа, связанность     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Сравнение подходов

| Аспект | Choreography | Orchestration |
|--------|--------------|---------------|
| Связанность | Слабая | Сильная (к оркестратору) |
| Понятность | Сложно отследить | Легко понять |
| Добавление шага | Просто | Изменить оркестратор |
| Точка отказа | Нет | Оркестратор |
| Тестирование | Сложно | Проще |

### Saga vs 2PC

```
┌─────────────────────────────────────────────────────────┐
│                    SAGA vs 2PC                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                    2PC              SAGA                │
│  ─────────────────────────────────────────────────────  │
│  Изоляция         Полная           Нет (ACD)            │
│  Блокировки       Да               Нет                  │
│  Доступность      Низкая           Высокая              │
│  Сложность        Средняя          Высокая              │
│  Откат            Автоматический   Компенсации          │
│  Масштабируемость Плохая           Хорошая              │
│                                                         │
│  SAGA обеспечивает ACD (без Isolation):                 │
│  A — Atomicity (через компенсации)                      │
│  C — Consistency (eventual)                             │
│  D — Durability (каждый шаг сохраняется)                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Проблемы Saga

```
┌─────────────────────────────────────────────────────────┐
│                   ПРОБЛЕМЫ SAGA                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. НЕТ ИЗОЛЯЦИИ (Dirty Reads)                          │
│     Пока Saga выполняется, другие видят промежуточные   │
│     состояния                                           │
│                                                         │
│     Saga: Order=PENDING → Inventory=RESERVED → ...      │
│     Другой запрос видит: Order=PENDING, но товар уже    │
│     зарезервирован!                                     │
│                                                         │
│  2. СЛОЖНЫЕ КОМПЕНСАЦИИ                                 │
│     Не всё можно откатить:                              │
│     • Email отправлен — не вернуть                      │
│     • Товар отправлен — сложно вернуть                  │
│     • Внешний API вызван — не откатить                  │
│                                                         │
│  3. ИДЕМПОТЕНТНОСТЬ                                     │
│     Компенсации могут вызываться повторно               │
│     Нужно делать их идемпотентными!                     │
│                                                         │
│  Решения:                                               │
│  • Semantic locks (статусы PENDING)                     │
│  • Commutative updates (порядок не важен)               │
│  • Pessimistic view (показывать худший случай)          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Рекомендации по реализации Saga

```
┌─────────────────────────────────────────────────────────┐
│                  РЕКОМЕНДАЦИИ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Используй Orchestration для сложных Saga            │
│     (> 3 шагов, сложная логика)                         │
│                                                         │
│  2. Храни состояние Saga в БД                           │
│     (чтобы восстановиться после падения)                │
│                                                         │
│  3. Делай шаги идемпотентными                           │
│     (retry-safe)                                        │
│                                                         │
│  4. Используй статусы для изоляции                      │
│     PENDING → CONFIRMED → COMPLETED                     │
│                                                         │
│  5. Логируй каждый шаг                                  │
│     (для отладки и аудита)                              │
│                                                         │
│  6. Тестируй сценарии отказов                           │
│     (что если шаг 3 из 5 упал?)                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Ключевые термины

| Термин | Определение |
|--------|-------------|
| **Микросервисы** | Архитектура из независимых сервисов |
| **2PC** | Two-Phase Commit — протокол распределённых транзакций |
| **Coordinator** | Узел, управляющий 2PC транзакцией |
| **Participant** | Узел, участвующий в 2PC транзакции |
| **Saga** | Цепочка локальных транзакций с компенсациями |
| **Компенсация** | Транзакция, отменяющая эффект предыдущей |
| **Choreography** | Saga через события между сервисами |
| **Orchestration** | Saga с центральным координатором |

---

## Что запомнить

1. **Микросервисы — не серебряная пуля**, начинай с монолита
2. **2PC блокирует ресурсы** — используй только когда нужна строгая консистентность
3. **Saga — альтернатива 2PC** для высоконагруженных систем
4. **Choreography проще, Orchestration понятнее**
5. **Компенсации — это НЕ rollback**, а новые транзакции
6. **Saga не даёт изоляции** — используй semantic locks

---

*Следующий файл: [07. Проектирование под нагрузку](07_load_design.md)*

