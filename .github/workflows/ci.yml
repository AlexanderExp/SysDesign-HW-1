name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Run linter
      run: make lint

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Create .env file for CI
      run: cp .github/workflows/.env.ci .env

    - name: Start services with Docker Compose
      run: docker compose up -d

    - name: Wait for services to be ready
      run: |
        echo "Waiting for databases to be healthy..."
        timeout 60 bash -c 'until docker compose ps db-rental | grep -q "healthy"; do sleep 2; done'
        timeout 60 bash -c 'until docker compose ps db-billing | grep -q "healthy"; do sleep 2; done'

        echo "Running database migrations..."
        DATABASE_URL=postgresql+psycopg2://app:app@localhost:5433/rental make migrate-rental
        BILLING_DATABASE_URL=postgresql+psycopg2://app:app@localhost:5434/billing make migrate-billing

        echo "Waiting for external services..."
        timeout 60 bash -c 'until docker compose ps external-stubs | grep -q "healthy"; do sleep 2; done'
        
        echo "Restarting application services..."
        docker compose restart rental-core billing-worker
        
        echo "Waiting for services to start..."
        timeout 60 bash -c 'until docker compose ps rental-core | grep -q "Up"; do sleep 2; done'
        timeout 60 bash -c 'until docker compose ps billing-worker | grep -q "Up"; do sleep 2; done'

        echo "Checking service health..."
        timeout 60 bash -c 'until curl -f http://localhost:3629/configs >/dev/null 2>&1; do sleep 2; done'
        timeout 60 bash -c 'until curl -f http://localhost:8000/api/v1/health >/dev/null 2>&1; do sleep 2; done'

        echo "All services are ready!"

    - name: Run tests
      env:
        DATABASE_URL: postgresql+psycopg2://app:app@localhost:5433/rental
        BILLING_DATABASE_URL: postgresql+psycopg2://app:app@localhost:5434/billing
        EXTERNAL_BASE: http://localhost:3629
        RENTAL_CORE_BASE: http://localhost:8000
      run: make test

    - name: Stop services
      if: always()
      run: docker compose down

