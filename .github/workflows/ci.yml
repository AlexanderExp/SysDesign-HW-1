name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Run linter
      run: make lint

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Create .env file for CI
      run: cp .github/workflows/.env.ci .env

    - name: Start services with Docker Compose
      run: docker compose up -d

    - name: Wait for services to be ready
      run: |
        echo "Waiting for rental database to be healthy..."
        timeout 60 bash -c 'until docker compose ps db-rental | grep -q "healthy"; do sleep 2; done'

        echo "Waiting for billing database to be healthy..."
        timeout 60 bash -c 'until docker compose ps db-billing | grep -q "healthy"; do sleep 2; done'

        echo "Running database migrations..."
        make migrate-rental
        make migrate-billing

        echo "Verifying database tables exist..."
        docker exec $(docker compose ps -q db-rental) psql -U app -d rental -c "\dt" || echo "No tables in rental DB"
        docker exec $(docker compose ps -q db-billing) psql -U app -d billing -c "\dt" || echo "No tables in billing DB"

        echo "Restarting application services after migrations..."
        docker compose restart rental-core billing-worker

        echo "Waiting for external-stubs to be healthy..."
        timeout 60 bash -c 'until docker compose ps external-stubs | grep -q "healthy"; do sleep 2; done'

        echo "Waiting for rental-core to be up..."
        timeout 60 bash -c 'until docker compose ps rental-core | grep -q "Up"; do sleep 2; done'

        echo "Waiting for billing-worker to be up..."
        timeout 60 bash -c 'until docker compose ps billing-worker | grep -q "Up"; do sleep 2; done'

        echo "Waiting for HTTP services to respond..."
        timeout 60 bash -c 'until curl -f http://localhost:3629/configs >/dev/null 2>&1; do echo "Waiting for external-stubs..."; sleep 2; done'
        timeout 60 bash -c 'until curl -f http://localhost:8000/health >/dev/null 2>&1; do echo "Waiting for rental-core..."; sleep 2; done'

        echo "All services are ready!"
        docker compose ps

        echo "Checking service logs for errors..."
        echo "=== rental-core logs ==="
        docker compose logs rental-core --tail=20
        echo "=== external-stubs logs ==="
        docker compose logs external-stubs --tail=10

        echo "Service endpoints:"
        curl -s http://localhost:3629/configs | head -3 || echo "external-stubs not responding"
        curl -s http://localhost:8000/health || echo "rental-core not responding"

    - name: Run tests
      env:
        DATABASE_URL: postgresql+psycopg2://app:app@localhost:5433/rental
        BILLING_DATABASE_URL: postgresql+psycopg2://app:app@localhost:5434/billing
        EXTERNAL_BASE: http://localhost:3629
        RENTAL_CORE_BASE: http://localhost:8000
      run: make test

    - name: Stop services
      if: always()
      run: docker compose down

